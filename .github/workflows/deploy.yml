name: CI/CD Pipeline - Smart Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      force_deploy_game_server:
        description: 'Force deploy Game Server (ignore change detection)'
        type: boolean
        default: false
      force_deploy_web:
        description: 'Force deploy Web Application (ignore change detection)'
        type: boolean
        default: false
      force_deploy_full:
        description: 'Force deploy Full Infrastructure (ignore change detection)'
        type: boolean
        default: false
      retry_failed_deployments:
        description: 'Retry previously failed deployments'
        type: boolean
        default: true

env:
  # Repositoryì—ì„œ í™˜ê²½ë³€ìˆ˜ ì£¼ì…
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  
  # ì„œë²„ ì„¤ì •
  DEPLOY_PATH: /home/${{ secrets.SSH_USER }}/blokus-online
  DOCKER_COMPOSE_FILE: docker-compose.yml

jobs:
  detect-changes:
    name: Detect Changed Files and Deployment State
    runs-on: ubuntu-latest
    outputs:
      game-server-changed: ${{ steps.changes.outputs.game-server }}
      web-changed: ${{ steps.changes.outputs.web }}
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure }}
      force-game-server: ${{ steps.deployment-logic.outputs.force-game-server }}
      force-web: ${{ steps.deployment-logic.outputs.force-web }}
      force-infrastructure: ${{ steps.deployment-logic.outputs.force-infrastructure }}
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ë³€ê²½ì‚¬í•­ ê°ì§€
      id: changes
      run: |
        # ì´ì „ ì»¤ë°‹ê³¼ í˜„ì¬ ì»¤ë°‹ ê°„ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        if [ "${{ github.event_name }}" = "push" ]; then
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # ìƒˆë¡œìš´ ë¸Œëœì¹˜ì¸ ê²½ìš° HEADì™€ HEAD~1 ë¹„êµ
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
        else
          # workflow_dispatchì˜ ê²½ìš° ìˆ˜ë™ ë¹Œë“œ í”Œë˜ê·¸ ì„¤ì •
          MANUAL_BUILD=true
          CHANGED_FILES=""
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo "--- End of changed files ---"
        
        # ê²Œì„ ì„œë²„ ê´€ë ¨ ë³€ê²½ì‚¬í•­ ì²´í¬
        GAME_SERVER_CHANGED=false
        GAME_SERVER_FILES=$(echo "$CHANGED_FILES" | grep -E '^(server/|client/|common/|proto/|CMakeLists\.txt|vcpkg\.json)' || true)
        if [ ! -z "$GAME_SERVER_FILES" ]; then
          GAME_SERVER_CHANGED=true
          echo "Game server files changed: $GAME_SERVER_FILES"
        fi
        
        # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë ¨ ë³€ê²½ì‚¬í•­ ì²´í¬
        WEB_CHANGED=false
        WEB_FILES=$(echo "$CHANGED_FILES" | grep -E '^web/' || true)
        if [ ! -z "$WEB_FILES" ]; then
          WEB_CHANGED=true
          echo "Web files changed: $WEB_FILES"
        fi
        
        # ì¸í”„ë¼ ê´€ë ¨ ë³€ê²½ì‚¬í•­ ì²´í¬
        INFRASTRUCTURE_CHANGED=false
        INFRA_FILES=$(echo "$CHANGED_FILES" | grep -E '^(docker-compose\.yml|\.github/|\.env\.example)' || true)
        if [ ! -z "$INFRA_FILES" ]; then
          INFRASTRUCTURE_CHANGED=true
          echo "Infrastructure files changed: $INFRA_FILES"
        fi
        
        # ìˆ˜ë™ ë¹Œë“œì´ê±°ë‚˜ ì¸í”„ë¼ ë³€ê²½ì´ ìˆìœ¼ë©´ ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ë¹Œë“œ
        if [ "$MANUAL_BUILD" = "true" ] || [ "$INFRASTRUCTURE_CHANGED" = "true" ]; then
          GAME_SERVER_CHANGED=true
          WEB_CHANGED=true
          INFRASTRUCTURE_CHANGED=true
          echo "Manual build or infrastructure change detected - building all services"
        fi
        
        echo "game-server=$GAME_SERVER_CHANGED" >> $GITHUB_OUTPUT
        echo "web=$WEB_CHANGED" >> $GITHUB_OUTPUT
        echo "infrastructure=$INFRASTRUCTURE_CHANGED" >> $GITHUB_OUTPUT
        
        echo "Game Server Changed: $GAME_SERVER_CHANGED"
        echo "Web Changed: $WEB_CHANGED"
        echo "Infrastructure Changed: $INFRASTRUCTURE_CHANGED"

    - name: SSH í‚¤ ì„¤ì • (ë°°í¬ ìƒíƒœ í™•ì¸ìš©)
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: ì´ì „ ë°°í¬ ìƒíƒœ í™•ì¸ ë° ë°°í¬ ê²°ì • ë¡œì§
      id: deployment-logic
      run: |
        echo "=== Deployment Decision Logic ==="
        
        # ê¸°ë³¸ ë³€ê²½ ê°ì§€ ê²°ê³¼
        GAME_SERVER_CHANGED="${{ steps.changes.outputs.game-server }}"
        WEB_CHANGED="${{ steps.changes.outputs.web }}"
        INFRASTRUCTURE_CHANGED="${{ steps.changes.outputs.infrastructure }}"
        
        # ê°•ì œ ë°°í¬ í”Œë˜ê·¸ í™•ì¸
        FORCE_GAME_SERVER="${{ github.event.inputs.force_deploy_game_server }}"
        FORCE_WEB="${{ github.event.inputs.force_deploy_web }}"
        FORCE_INFRASTRUCTURE="${{ github.event.inputs.force_deploy_full }}"
        RETRY_FAILED="${{ github.event.inputs.retry_failed_deployments }}"
        
        # ê¸°ë³¸ê°’ ì„¤ì • (workflow_dispatchê°€ ì•„ë‹Œ ê²½ìš°)
        if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
          RETRY_FAILED="true"
        fi
        
        echo "Force Game Server: $FORCE_GAME_SERVER"
        echo "Force Web: $FORCE_WEB"  
        echo "Force Infrastructure: $FORCE_INFRASTRUCTURE"
        echo "Retry Failed: $RETRY_FAILED"
        
        # ì„œë²„ì—ì„œ ì´ì „ ë°°í¬ ìƒíƒœ í™•ì¸ (JSON ê¸°ë°˜)
        LAST_DEPLOYMENT_STATUS=""
        if [ "$RETRY_FAILED" = "true" ]; then
          echo "Checking previous deployment status on server..."
          LAST_DEPLOYMENT_STATUS=$(ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
            if [ -f ${{ env.DEPLOY_PATH }}/.deployment_status.json ]; then
              cat ${{ env.DEPLOY_PATH }}/.deployment_status.json
            else
              echo '{\"initialized\": false}'
            fi
          " 2>/dev/null || echo '{\"error\": \"connection_failed\"}')
          
          echo "Previous deployment status: $LAST_DEPLOYMENT_STATUS"
        fi
        
        # ìµœì¢… ë°°í¬ ê²°ì •
        DEPLOY_GAME_SERVER=false
        DEPLOY_WEB=false  
        DEPLOY_INFRASTRUCTURE=false
        
        # JSON ê¸°ë°˜ ë°°í¬ ê²°ì • ë¡œì§
        # Game Server ë°°í¬ ê²°ì •
        if [ "$FORCE_GAME_SERVER" = "true" ] || [ "$GAME_SERVER_CHANGED" = "true" ]; then
          DEPLOY_GAME_SERVER=true
          echo "Game Server deployment: Required (force=$FORCE_GAME_SERVER, changed=$GAME_SERVER_CHANGED)"
        elif [ "$RETRY_FAILED" = "true" ] && echo "$LAST_DEPLOYMENT_STATUS" | grep -q '"game_server".*"failed"'; then
          DEPLOY_GAME_SERVER=true
          echo "Game Server deployment: Required (previous deployment failed)"
        fi
        
        # Web Application ë°°í¬ ê²°ì •  
        if [ "$FORCE_WEB" = "true" ] || [ "$WEB_CHANGED" = "true" ]; then
          DEPLOY_WEB=true
          echo "Web deployment: Required (force=$FORCE_WEB, changed=$WEB_CHANGED)"
        elif [ "$RETRY_FAILED" = "true" ] && echo "$LAST_DEPLOYMENT_STATUS" | grep -q '"web".*"failed"'; then
          DEPLOY_WEB=true
          echo "Web deployment: Required (previous deployment failed)"
        fi
        
        # Infrastructure ë°°í¬ ê²°ì •
        if [ "$FORCE_INFRASTRUCTURE" = "true" ] || [ "$INFRASTRUCTURE_CHANGED" = "true" ]; then
          DEPLOY_INFRASTRUCTURE=true
          echo "Infrastructure deployment: Required (force=$FORCE_INFRASTRUCTURE, changed=$INFRASTRUCTURE_CHANGED)"
        elif [ "$RETRY_FAILED" = "true" ] && echo "$LAST_DEPLOYMENT_STATUS" | grep -q '"infrastructure".*"failed"'; then
          DEPLOY_INFRASTRUCTURE=true
          echo "Infrastructure deployment: Required (previous deployment failed)"
        fi
        
        # ì¶œë ¥ ì„¤ì •
        echo "force-game-server=$DEPLOY_GAME_SERVER" >> $GITHUB_OUTPUT
        echo "force-web=$DEPLOY_WEB" >> $GITHUB_OUTPUT
        echo "force-infrastructure=$DEPLOY_INFRASTRUCTURE" >> $GITHUB_OUTPUT
        
        echo "=== Final Deployment Decision ==="
        echo "Game Server: $DEPLOY_GAME_SERVER"
        echo "Web Application: $DEPLOY_WEB"
        echo "Infrastructure: $DEPLOY_INFRASTRUCTURE"

  shared-setup:
    name: Shared Setup (Common Tasks + Docker Cache Setup)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.force-game-server == 'true' || 
      needs.detect-changes.outputs.force-web == 'true' || 
      needs.detect-changes.outputs.force-infrastructure == 'true'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        driver-opts: network=host
        
    - name: ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ì˜ì¡´ì„± í™•ì¸
      run: |
        # SSH ì—°ê²° ì¬ì‹œë„ í•¨ìˆ˜
        ssh_with_retry() {
          local max_attempts=5
          local delay=2
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "SSH connection attempt $attempt/$max_attempts..."
            
            if ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} -o ConnectTimeout=30 -o ServerAliveInterval=10 "$@"; then
              echo "SSH connection successful!"
              return 0
            else
              echo "SSH connection failed (attempt $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "All SSH connection attempts failed!"
                return 1
              fi
              echo "Waiting ${delay}s before retry..."
              sleep $delay
              delay=$((delay * 2)) # Exponential backoff
              attempt=$((attempt + 1))
            fi
          done
        }
        
        # ì„œë²„ ì—°ê²° ë° ì˜ì¡´ì„± í™•ì¸
        ssh_with_retry "
          echo 'Server connection successful!' && 
          echo 'Checking required dependencies...' && 
          
          # Check required tools
          missing_deps=()
          
          if ! command -v docker >/dev/null 2>&1; then
            missing_deps+=(docker)
          fi
          
          if ! command -v jq >/dev/null 2>&1; then
            missing_deps+=(jq)
          fi
          
          if ! command -v flock >/dev/null 2>&1; then
            missing_deps+=(flock)
          fi
          
          if [ \${#missing_deps[@]} -ne 0 ]; then
            echo 'ERROR: Missing required dependencies:' \"\${missing_deps[*]}\"
            echo 'Please install missing dependencies on the server'
            exit 1
          fi
          
          echo 'All required dependencies are available!' &&
          echo 'System info:' &&
          echo '  Docker:' \$(docker --version) &&
          echo '  jq:' \$(jq --version) &&
          echo '  Available disk space:' &&
          df -h ${{ env.DEPLOY_PATH }} 2>/dev/null || df -h /
        "
        
    - name: ê³µí†µ ì†ŒìŠ¤ì½”ë“œ ë™ê¸°í™”
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          mkdir -p ${{ env.DEPLOY_PATH }} && 
          cd ${{ env.DEPLOY_PATH }} && 
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git fetch origin main &&
            git reset --hard origin/main
          fi
        "
        
    - name: ê³µí†µ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ì¸í”„ë¼ ë³€ê²½ì‹œì—ë§Œ)
      if: needs.detect-changes.outputs.infrastructure-changed == 'true'
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \\
          
          # í™˜ê²½ë³€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì •
          JWT_SECRET='${{ secrets.JWT_SECRET }}'
          SESSION_TIMEOUT_HOURS='${{ secrets.SESSION_TIMEOUT_HOURS }}'
          PASSWORD_SALT_ROUNDS='${{ secrets.PASSWORD_SALT_ROUNDS }}'
          LOG_LEVEL='${{ secrets.LOG_LEVEL }}'
          LOG_DIRECTORY='${{ secrets.LOG_DIRECTORY }}'
          DEBUG_MODE='${{ secrets.DEBUG_MODE }}'
          ENABLE_SQL_LOGGING='${{ secrets.ENABLE_SQL_LOGGING }}'
          
          # JWT ì‹œí¬ë¦¿ ìë™ ìƒì„± (ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°)
          if [ -z \"\$JWT_SECRET\" ]; then
            JWT_SECRET=\$(openssl rand -hex 32)
            echo 'WARNING: JWT_SECRET not set, auto-generated. Please set it in Repository Secrets for security!'
          fi
          
          cat > .env << EOF
        # =========================
        # ê²Œì„ ì„œë²„ ì„¤ì •
        # =========================
        SERVER_PORT=${{ secrets.SERVER_PORT }}
        SERVER_MAX_CLIENTS=${{ secrets.SERVER_MAX_CLIENTS }}
        SERVER_THREAD_POOL_SIZE=${{ secrets.SERVER_THREAD_POOL_SIZE }}
        BLOKUS_SERVER_VERSION=${{ secrets.BLOKUS_SERVER_VERSION }}
        BLOKUS_DOWNLOAD_URL=${{ secrets.BLOKUS_DOWNLOAD_URL }}
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ê²Œì„ ì„œë²„ìš©)
        DB_HOST=postgres
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}
        
        # PostgreSQL ì„¤ì •
        POSTGRES_DB=${{ secrets.DB_NAME }}
        POSTGRES_USER=${{ secrets.DB_USER }}
        POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # ë³´ì•ˆ ì„¤ì •
        JWT_SECRET=\$JWT_SECRET
        SESSION_TIMEOUT_HOURS=\${SESSION_TIMEOUT_HOURS:-24}
        PASSWORD_SALT_ROUNDS=\${PASSWORD_SALT_ROUNDS:-12}
        
        # ë¡œê¹… ì„¤ì •
        LOG_LEVEL=\${LOG_LEVEL:-info}
        LOG_DIRECTORY=\${LOG_DIRECTORY:-/app/logs}
        
        # ê°œë°œ ì„¤ì •
        DEBUG_MODE=\${DEBUG_MODE:-false}
        ENABLE_SQL_LOGGING=\${ENABLE_SQL_LOGGING:-false}
        
        # =========================
        # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
        # =========================
        WEB_PORT=${{ secrets.WEB_PORT }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL }}
        WEB_CLIENT_DOWNLOAD_URL=${{ secrets.WEB_CLIENT_DOWNLOAD_URL }}
        WEB_DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/blokus_online
        
        # ì›¹ ì¸ì¦ ì„¤ì •
        WEB_NEXTAUTH_SECRET=${{ secrets.WEB_NEXTAUTH_SECRET }}
        WEB_JWT_SECRET=${{ secrets.WEB_JWT_SECRET }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        
        # ì›¹ ê´€ë¦¬ì ê³„ì •
        WEB_ADMIN_USERNAME=${{ secrets.WEB_ADMIN_USERNAME }}
        WEB_ADMIN_PASSWORD=${{ secrets.WEB_ADMIN_PASSWORD }}
        
        # SSL/ë„ë©”ì¸ ì„¤ì •
        DOMAIN=${{ secrets.DOMAIN }}
        CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}
        EOF
        "
        
    - name: ê³µí†µ ë””ë ‰í† ë¦¬ ì„¤ì • (ì¸í”„ë¼ ë³€ê²½ì‹œì—ë§Œ)
      if: needs.detect-changes.outputs.infrastructure-changed == 'true'
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \\
          
          # ê¸°ë³¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p downloads web/uploads certbot/conf certbot/www && \\
          
          # logs ë””ë ‰í† ë¦¬ ê°•ì œ ì •ë¦¬ ë° ì¬ìƒì„±
          rm -rf logs 2>/dev/null || echo 'logs cleanup completed' && \\
          mkdir -p logs/nginx && \\
          
          # ê¶Œí•œ ì„¤ì •
          chmod 755 downloads web/uploads logs logs/nginx certbot/conf certbot/www && \\
          echo 'All directories created and configured successfully'
        "

  deploy-game-server:
    name: Deploy Game Server (Optimized Build)
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup]
    if: needs.detect-changes.outputs.force-game-server == 'true'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        
    - name: ê²Œì„ ì„œë²„ ë¹Œë“œ ë° ì¬ì‹œì‘ (ìºì‹œ ìµœì í™”)
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          export DOCKER_BUILDKIT=1 && 
          export COMPOSE_DOCKER_CLI_BUILD=1 && 
          export BUILDKIT_PROGRESS=plain && 
          
          # ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì •ì˜
          update_deployment_status() {
            local service=\$1
            local status=\$2
            local timestamp=\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")
            
            # Lock fileì„ ì‚¬ìš©í•œ ì›ìì  ì—…ë°ì´íŠ¸
            (
              flock -x 200
              if [ -f .deployment_status.json ]; then
                current_status=\$(cat .deployment_status.json)
              else
                current_status='{}'
              fi
              
              echo \"\$current_status\" | jq --arg service \"\$service\" --arg status \"\$status\" --arg timestamp \"\$timestamp\" \
                '. + {\$service: \$status, (\$service + \"_timestamp\"): \$timestamp}' > .deployment_status.json.tmp && \
              mv .deployment_status.json.tmp .deployment_status.json
            ) 200>.deployment_status.lock
          }
          
          # ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œì‘)
          update_deployment_status 'game_server' 'deploying' && 
          
          # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸
          echo 'Checking system resources before build...'
          df -h ${{ env.DEPLOY_PATH }} | head -2
          free -h
          
          # Docker ìºì‹œ ì„¤ì • (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ìµœì í™”)
          export BUILDX_NO_DEFAULT_ATTESTATIONS=1
          
          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ë¹Œë“œ (ì¬ì‹œë„ ë¡œì§ + ìºì‹œ ìµœì í™”)
          for i in {1..3}; do
            echo \"Starting game server build attempt \$i/3 with cache optimization...\"
            
            if docker compose stop blokus-server && \
               timeout 1200 docker compose build blokus-server \
                 --progress=plain \
                 --build-arg BUILDKIT_INLINE_CACHE=1 && \
               docker compose up -d blokus-server --wait --wait-timeout 180; then
              echo 'Game server deployment successful!'
              break
            elif [ \$i -eq 3 ]; then
              echo 'Game server deployment failed after 3 attempts'
              echo 'Checking Docker logs for debugging:'
              docker compose logs blokus-server --tail=50 || true
              exit 1
            else
              echo \"Game server deployment attempt \$i failed, retrying...\"
              echo 'Cleaning up failed build artifacts...'
              docker compose down blokus-server || true
              # ë¹Œë“œ ìºì‹œëŠ” ìœ ì§€í•˜ê³  ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬
              docker container prune -f || true
              sleep 30
            fi
          done && 
          
          # ë°°í¬ ì„±ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸
          update_deployment_status 'game_server' 'success'
        "

    - name: ê²Œì„ ì„œë²„ ë°°í¬ ì‹¤íŒ¨ ì²˜ë¦¬
      if: failure()
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          
          # ë°°í¬ ì‹¤íŒ¨ ìƒíƒœ ì—…ë°ì´íŠ¸
          timestamp=\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")
          (
            flock -x 200
            if [ -f .deployment_status.json ]; then
              current_status=\$(cat .deployment_status.json)
            else
              current_status='{}'
            fi
            
            echo \"\$current_status\" | jq --arg timestamp \"\$timestamp\" \
              '. + {\"game_server\": \"failed\", \"game_server_timestamp\": \$timestamp}' > .deployment_status.json.tmp && \
            mv .deployment_status.json.tmp .deployment_status.json
          ) 200>.deployment_status.lock
        " || true

  deploy-web:
    name: Deploy Web Application (Optimized Build)
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup]
    if: needs.detect-changes.outputs.force-web == 'true'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        
    - name: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ì¬ì‹œì‘ (ìºì‹œ ìµœì í™”)
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          export DOCKER_BUILDKIT=1 && 
          export COMPOSE_DOCKER_CLI_BUILD=1 && 
          export BUILDKIT_PROGRESS=plain && 
          
          # ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì •ì˜
          update_deployment_status() {
            local service=\$1
            local status=\$2
            local timestamp=\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")
            
            # Lock fileì„ ì‚¬ìš©í•œ ì›ìì  ì—…ë°ì´íŠ¸
            (
              flock -x 200
              if [ -f .deployment_status.json ]; then
                current_status=\$(cat .deployment_status.json)
              else
                current_status='{}'
              fi
              
              echo \"\$current_status\" | jq --arg service \"\$service\" --arg status \"\$status\" --arg timestamp \"\$timestamp\" \
                '. + {\$service: \$status, (\$service + \"_timestamp\"): \$timestamp}' > .deployment_status.json.tmp && \
              mv .deployment_status.json.tmp .deployment_status.json
            ) 200>.deployment_status.lock
          }
          
          # ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œì‘)
          update_deployment_status 'web' 'deploying' && 
          
          # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸
          echo 'Checking system resources before web build...'
          df -h ${{ env.DEPLOY_PATH }} | head -2
          free -h
          
          # Docker ìºì‹œ ì„¤ì • (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ìµœì í™”)
          export BUILDX_NO_DEFAULT_ATTESTATIONS=1
          
          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ë¹Œë“œ (ì¬ì‹œë„ ë¡œì§ + ìºì‹œ ìµœì í™”)
          for i in {1..3}; do
            echo \"Starting web application build attempt \$i/3 with cache optimization...\"
            
            if docker compose stop blokus-web && \
               timeout 900 docker compose build blokus-web \
                 --progress=plain \
                 --build-arg BUILDKIT_INLINE_CACHE=1 && \
               docker compose up -d blokus-web --wait --wait-timeout 240; then
              echo 'Web application deployment successful!'
              break
            elif [ \$i -eq 3 ]; then
              echo 'Web application deployment failed after 3 attempts'
              echo 'Checking Docker logs for debugging:'
              docker compose logs blokus-web --tail=50 || true
              exit 1
            else
              echo \"Web deployment attempt \$i failed, retrying...\"
              echo 'Cleaning up failed build artifacts...'
              docker compose down blokus-web || true
              # ë¹Œë“œ ìºì‹œëŠ” ìœ ì§€í•˜ê³  ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬
              docker container prune -f || true
              sleep 30
            fi
          done && 
          
          # ë°°í¬ ì„±ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸
          update_deployment_status 'web' 'success'
        "

    - name: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹¤íŒ¨ ì²˜ë¦¬
      if: failure()
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          
          # ë°°í¬ ì‹¤íŒ¨ ìƒíƒœ ì—…ë°ì´íŠ¸
          timestamp=\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")
          (
            flock -x 200
            if [ -f .deployment_status.json ]; then
              current_status=\$(cat .deployment_status.json)
            else
              current_status='{}'
            fi
            
            echo \"\$current_status\" | jq --arg timestamp \"\$timestamp\" \
              '. + {\"web\": \"failed\", \"web_timestamp\": \$timestamp}' > .deployment_status.json.tmp && \
            mv .deployment_status.json.tmp .deployment_status.json
          ) 200>.deployment_status.lock
        " || true

  deploy-full:
    name: Full Deploy (Infrastructure Changes)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.force-infrastructure == 'true'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
      run: |
        # í•„ìˆ˜ secrets ì²´í¬
        if [ -z "${{ secrets.SSH_HOST }}" ] || [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_KEY }}" ]; then
          echo "ERROR: Required SSH connection information is missing!"
          echo "Required Repository Secrets: SSH_HOST, SSH_USER, SSH_KEY, SSH_PORT"
          exit 1
        fi
        
        if [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASSWORD }}" ] || [ -z "${{ secrets.DB_NAME }}" ]; then
          echo "ERROR: Required database information is missing!"
          echo "Required Repository Secrets: DB_USER, DB_PASSWORD, DB_NAME"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_PORT }}" ]; then
          echo "ERROR: Server port is not configured!"
          echo "Required Repository Secret: SERVER_PORT"
          exit 1
        fi
        
        # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
        if [ -z "${{ secrets.WEB_APP_URL }}" ]; then
          echo "ERROR: Required web application information is missing!"
          echo "Required Repository Secrets: WEB_APP_URL"
          exit 1
        fi
        
        if [ -z "${{ secrets.WEB_ADMIN_USERNAME }}" ] || [ -z "${{ secrets.WEB_ADMIN_PASSWORD }}" ]; then
          echo "ERROR: Web admin account information is missing!"
          echo "Required Repository Secrets: WEB_ADMIN_USERNAME, WEB_ADMIN_PASSWORD"
          exit 1
        fi
        
        echo "Required environment variables check completed"
        
    - name: ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "echo 'Server connection successful!'"
        
    - name: ì„œë²„ì— ì†ŒìŠ¤ì½”ë“œ ë°°í¬
      run: |
        # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
        
        # Git ì €ì¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git fetch origin main
            git reset --hard origin/main
          fi
        "
        
    - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          
          # í™˜ê²½ë³€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì •
          JWT_SECRET='${{ secrets.JWT_SECRET }}'
          SESSION_TIMEOUT_HOURS='${{ secrets.SESSION_TIMEOUT_HOURS }}'
          PASSWORD_SALT_ROUNDS='${{ secrets.PASSWORD_SALT_ROUNDS }}'
          LOG_LEVEL='${{ secrets.LOG_LEVEL }}'
          LOG_DIRECTORY='${{ secrets.LOG_DIRECTORY }}'
          DEBUG_MODE='${{ secrets.DEBUG_MODE }}'
          ENABLE_SQL_LOGGING='${{ secrets.ENABLE_SQL_LOGGING }}'
          
          # JWT ì‹œí¬ë¦¿ ìë™ ìƒì„± (ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°)
          if [ -z \"\$JWT_SECRET\" ]; then
            JWT_SECRET=\$(openssl rand -hex 32)
            echo 'WARNING: JWT_SECRET not set, auto-generated. Please set it in Repository Secrets for security!'
          fi
          
          cat > .env << EOF
        # =========================
        # ê²Œì„ ì„œë²„ ì„¤ì •
        # =========================
        SERVER_PORT=${{ secrets.SERVER_PORT }}
        SERVER_MAX_CLIENTS=${{ secrets.SERVER_MAX_CLIENTS }}
        SERVER_THREAD_POOL_SIZE=${{ secrets.SERVER_THREAD_POOL_SIZE }}
        BLOKUS_SERVER_VERSION=${{ secrets.BLOKUS_SERVER_VERSION }}
        BLOKUS_DOWNLOAD_URL=${{ secrets.BLOKUS_DOWNLOAD_URL }}
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ê²Œì„ ì„œë²„ìš©)
        DB_HOST=postgres
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}
        
        # PostgreSQL ì„¤ì •
        POSTGRES_DB=${{ secrets.DB_NAME }}
        POSTGRES_USER=${{ secrets.DB_USER }}
        POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # ë³´ì•ˆ ì„¤ì •
        JWT_SECRET=\$JWT_SECRET
        SESSION_TIMEOUT_HOURS=\${SESSION_TIMEOUT_HOURS:-24}
        PASSWORD_SALT_ROUNDS=\${PASSWORD_SALT_ROUNDS:-12}
        
        # ë¡œê¹… ì„¤ì •
        LOG_LEVEL=\${LOG_LEVEL:-info}
        LOG_DIRECTORY=\${LOG_DIRECTORY:-/app/logs}
        
        # ê°œë°œ ì„¤ì •
        DEBUG_MODE=\${DEBUG_MODE:-false}
        ENABLE_SQL_LOGGING=\${ENABLE_SQL_LOGGING:-false}
        
        # =========================
        # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
        # =========================
        WEB_PORT=${{ secrets.WEB_PORT }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL }}
        WEB_CLIENT_DOWNLOAD_URL=${{ secrets.WEB_CLIENT_DOWNLOAD_URL }}
        
        # ì›¹ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ë™ì¼í•œ PostgreSQL ì»¨í…Œì´ë„ˆ, ë‹¤ë¥¸ DBëª…)
        WEB_DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/blokus_online
        
        # ì›¹ ì¸ì¦ ì„¤ì •
        WEB_NEXTAUTH_SECRET=${{ secrets.WEB_NEXTAUTH_SECRET }}
        WEB_JWT_SECRET=${{ secrets.WEB_JWT_SECRET }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        
        # ì›¹ ê´€ë¦¬ì ê³„ì •
        WEB_ADMIN_USERNAME=${{ secrets.WEB_ADMIN_USERNAME }}
        WEB_ADMIN_PASSWORD=${{ secrets.WEB_ADMIN_PASSWORD }}
        
        # SSL/ë„ë©”ì¸ ì„¤ì •
        DOMAIN=${{ secrets.DOMAIN }}
        CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}
        EOF
        "
        
    - name: í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬ ì„¤ì •
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          
          # ê¸°ë³¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p downloads web/uploads certbot/conf certbot/www && \
          
          # logs ë””ë ‰í† ë¦¬ ê°•ì œ ì •ë¦¬ ë° ì¬ìƒì„±
          rm -rf logs 2>/dev/null || echo 'logs cleanup completed' && \
          mkdir -p logs/nginx && \
          
          # ê¶Œí•œ ì„¤ì •
          chmod 755 downloads web/uploads logs logs/nginx certbot/conf certbot/www && \
          echo 'All directories created and configured successfully'
        "
          
    - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          docker compose down
        "
        
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          export DOCKER_BUILDKIT=1 && \
          export COMPOSE_DOCKER_CLI_BUILD=1 && \
          
          # ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì •ì˜
          update_deployment_status() {
            local service=\$1
            local status=\$2
            local timestamp=\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")
            
            # Lock fileì„ ì‚¬ìš©í•œ ì›ìì  ì—…ë°ì´íŠ¸
            (
              flock -x 200
              if [ -f .deployment_status.json ]; then
                current_status=\$(cat .deployment_status.json)
              else
                current_status='{}'
              fi
              
              echo \"\$current_status\" | jq --arg service \"\$service\" --arg status \"\$status\" --arg timestamp \"\$timestamp\" \
                '. + {\$service: \$status, (\$service + \"_timestamp\"): \$timestamp}' > .deployment_status.json.tmp && \
              mv .deployment_status.json.tmp .deployment_status.json
            ) 200>.deployment_status.lock
          }
          
          # ë°°í¬ ìƒíƒœ ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸ (ì‹œì‘)
          update_deployment_status 'infrastructure' 'deploying' && \
          
          # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸
          echo 'Checking system resources before full infrastructure build...'
          df -h ${{ env.DEPLOY_PATH }} | head -2
          free -h
          echo 'Docker system info:'
          docker system df || true
          
          # Docker ìºì‹œ ì„¤ì • (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ìµœì í™”)
          export BUILDX_NO_DEFAULT_ATTESTATIONS=1
          
          # ì¸í”„ë¼ ì „ì²´ ë°°í¬ (ì¬ì‹œë„ ë¡œì§ + ìºì‹œ ìµœì í™”)
          for i in {1..2}; do
            echo \"Starting full infrastructure build attempt \$i/2 with cache optimization...\"
            
            # Docker ë¹Œë“œìš© í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export DOCKER_BUILDKIT=1
            export BUILDKIT_PROGRESS=plain
            export COMPOSE_PARALLEL_LIMIT=3
            
            # ëŒ€ìš©ëŸ‰ ë¹Œë“œë¥¼ ìœ„í•œ íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„ìœ¼ë¡œ ë‹¨ì¶•)
            if timeout 1800 docker compose build --parallel \
                 --progress=plain \
                 --build-arg BUILDKIT_INLINE_CACHE=1 && \
               docker compose up -d --wait --wait-timeout 600; then
              echo 'Full infrastructure deployment successful!'
              break
            elif [ \$i -eq 2 ]; then
              echo 'Infrastructure deployment failed after 2 attempts'
              echo 'Checking system resources and Docker logs:'
              df -h ${{ env.DEPLOY_PATH }} | head -2
              free -h
              docker compose logs --tail=100 || true
              exit 1
            else
              echo \"Infrastructure deployment attempt \$i failed, retrying...\"
              echo 'Performing selective cleanup before retry (preserving cache)...'
              docker compose down || true
              docker container prune -f || true
              docker image prune -f || true
              echo 'Waiting 60 seconds before retry...'
              sleep 60
            fi
          done && \
          
          # ë°°í¬ í›„ ì„œë¹„ìŠ¤ ê±´ê°•ì„± ì²´í¬
          echo 'Performing post-deployment health checks...'
          sleep 30  # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
          
          # ì„œë¹„ìŠ¤ë³„ ê±´ê°•ì„± í™•ì¸
          health_check_failed=false
          
          # Game Server ê±´ê°•ì„± ì²´í¬
          if docker compose ps blokus-server | grep -q 'healthy\\|Up'; then
            echo 'âœ“ Game Server is running'
          else
            echo 'âœ— Game Server health check failed'
            health_check_failed=true
          fi
          
          # Web Application ê±´ê°•ì„± ì²´í¬  
          if docker compose ps blokus-web | grep -q 'healthy\\|Up'; then
            echo 'âœ“ Web Application is running'
          else
            echo 'âœ— Web Application health check failed'
            health_check_failed=true
          fi
          
          # Database ê±´ê°•ì„± ì²´í¬
          if docker compose ps postgres | grep -q 'healthy\\|Up'; then
            echo 'âœ“ Database is running'
          else
            echo 'âœ— Database health check failed'
            health_check_failed=true
          fi
          
          if [ \"\$health_check_failed\" = \"true\" ]; then
            echo 'Health check failed, displaying logs for debugging:'
            docker compose logs --tail=100
            echo 'Infrastructure deployment completed but some services are unhealthy'
            update_deployment_status 'infrastructure' 'success_with_warnings'
          else
            echo 'All services are healthy!'
            # ë°°í¬ ì„±ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸
            update_deployment_status 'infrastructure' 'success'
          fi
        "
        
    - name: ì¸í”„ë¼ ë°°í¬ ì‹¤íŒ¨ ì²˜ë¦¬
      if: failure()
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          
          # ë°°í¬ ì‹¤íŒ¨ ìƒíƒœ ì—…ë°ì´íŠ¸
          timestamp=\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")
          (
            flock -x 200
            if [ -f .deployment_status.json ]; then
              current_status=\$(cat .deployment_status.json)
            else
              current_status='{}'
            fi
            
            echo \"\$current_status\" | jq --arg timestamp \"\$timestamp\" \
              '. + {\"infrastructure\": \"failed\", \"infrastructure_timestamp\": \$timestamp}' > .deployment_status.json.tmp && \
            mv .deployment_status.json.tmp .deployment_status.json
          ) 200>.deployment_status.lock
        " || true
        
        
    - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "Full infrastructure deployment successful!"
          echo "Game Server: ${{ secrets.WEB_APP_URL }}:${{ secrets.SERVER_PORT }}"
          echo "Website: https://${{ secrets.WEB_APP_URL }}"
          echo "Client Download Directory: ${{ env.DEPLOY_PATH }}/downloads"
        else
          echo "Full infrastructure deployment failed!"
        fi
        
  # ë³‘ë ¬ ë¹Œë“œë¥¼ ìœ„í•œ ê°œë³„ ì‘ì—…ë“¤
  parallel-game-server:
    name: Parallel Game Server Build
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup]
    if: needs.detect-changes.outputs.force-game-server == 'true' && needs.detect-changes.outputs.force-web == 'true'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: ê²Œì„ ì„œë²„ë§Œ ë¹Œë“œ (ë³‘ë ¬ ì‹¤í–‰ìš©)
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          export DOCKER_BUILDKIT=1 && 
          export BUILDKIT_PROGRESS=plain && 
          export BUILDX_NO_DEFAULT_ATTESTATIONS=1 && 
          
          echo 'Starting parallel game server build...' &&
          timeout 900 docker compose build blokus-server \
            --progress=plain \
            --build-arg BUILDKIT_INLINE_CACHE=1
        "
        
  parallel-web-app:
    name: Parallel Web App Build  
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup]
    if: needs.detect-changes.outputs.force-game-server == 'true' && needs.detect-changes.outputs.force-web == 'true'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: ì›¹ ì•±ë§Œ ë¹Œë“œ (ë³‘ë ¬ ì‹¤í–‰ìš©)
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          export DOCKER_BUILDKIT=1 && 
          export BUILDKIT_PROGRESS=plain && 
          export BUILDX_NO_DEFAULT_ATTESTATIONS=1 && 
          
          echo 'Starting parallel web app build...' &&
          timeout 600 docker compose build blokus-web \
            --progress=plain \
            --build-arg BUILDKIT_INLINE_CACHE=1
        "
        
  parallel-deploy:
    name: Parallel Services Deploy
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup, parallel-game-server, parallel-web-app]
    if: needs.detect-changes.outputs.force-game-server == 'true' && needs.detect-changes.outputs.force-web == 'true'
    
    steps:
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: ì„œë¹„ìŠ¤ ì‹œì‘ (ì´ë¯¸ ë¹Œë“œëœ ì´ë¯¸ì§€ ì‚¬ìš©)
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          
          echo 'Starting services with pre-built images...' &&
          docker compose up -d blokus-server blokus-web --wait --wait-timeout 300 &&
          echo 'Parallel deployment successful!'
        "

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup, deploy-game-server, deploy-web, deploy-full, parallel-deploy]
    if: always()
    
    steps:
    - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "=== Smart Deployment Summary ==="
        echo ""
        
        # ë³€ê²½ì‚¬í•­ ê°ì§€ ë° ë°°í¬ ê²°ì • ê²°ê³¼
        echo "ğŸ“Š Changes Detected:"
        echo "  - Game Server: ${{ needs.detect-changes.outputs.game-server-changed }}"
        echo "  - Web Application: ${{ needs.detect-changes.outputs.web-changed }}"
        echo "  - Infrastructure: ${{ needs.detect-changes.outputs.infrastructure-changed }}"
        echo ""
        
        echo "ğŸ¯ Deployment Decisions (including retry logic):"
        echo "  - Game Server: ${{ needs.detect-changes.outputs.force-game-server }}"
        echo "  - Web Application: ${{ needs.detect-changes.outputs.force-web }}"
        echo "  - Infrastructure: ${{ needs.detect-changes.outputs.force-infrastructure }}"
        echo ""
        
        # ê°œë³„ ë°°í¬ ê²°ê³¼
        echo "ğŸš€ Deployment Results:"
        
        if [ "${{ needs.detect-changes.outputs.force-game-server }}" = "true" ]; then
          if [ "${{ needs.deploy-game-server.result }}" = "success" ]; then
            echo "  âœ… Game Server: Successfully deployed"
          else
            echo "  âŒ Game Server: Deployment failed"
          fi
        else
          echo "  â­ï¸ Game Server: Skipped (no deployment needed)"
        fi
        
        if [ "${{ needs.detect-changes.outputs.force-web }}" = "true" ]; then
          if [ "${{ needs.deploy-web.result }}" = "success" ]; then
            echo "  âœ… Web Application: Successfully deployed"
          else
            echo "  âŒ Web Application: Deployment failed"
          fi
        else
          echo "  â­ï¸ Web Application: Skipped (no deployment needed)"
        fi
        
        if [ "${{ needs.detect-changes.outputs.force-infrastructure }}" = "true" ]; then
          if [ "${{ needs.deploy-full.result }}" = "success" ]; then
            echo "  âœ… Full Infrastructure: Successfully deployed"
          else
            echo "  âŒ Full Infrastructure: Deployment failed"
          fi
        else
          echo "  â­ï¸ Full Infrastructure: Skipped (no deployment needed)"
        fi
        
        echo ""
        echo "ğŸŒ Service URLs:"
        echo "  - Game Server: ${{ secrets.WEB_APP_URL }}:${{ secrets.SERVER_PORT }}"
        echo "  - Website: https://${{ secrets.WEB_APP_URL }}"
        
        # ì „ì²´ ì„±ê³µ ì—¬ë¶€ ì²´í¬ (ìƒˆë¡œìš´ ë¡œì§ ì ìš©)
        OVERALL_SUCCESS=true
        
        if [ "${{ needs.detect-changes.outputs.force-game-server }}" = "true" ] && [ "${{ needs.deploy-game-server.result }}" != "success" ]; then
          OVERALL_SUCCESS=false
        fi
        
        if [ "${{ needs.detect-changes.outputs.force-web }}" = "true" ] && [ "${{ needs.deploy-web.result }}" != "success" ]; then
          OVERALL_SUCCESS=false
        fi
        
        if [ "${{ needs.detect-changes.outputs.force-infrastructure }}" = "true" ] && [ "${{ needs.deploy-full.result }}" != "success" ]; then
          OVERALL_SUCCESS=false
        fi
        
        echo ""
        if [ "$OVERALL_SUCCESS" = "true" ]; then
          echo "ğŸ‰ Smart deployment completed successfully!"
          exit 0
        else
          echo "ğŸ’¥ Some deployments failed!"
          exit 1
        fi