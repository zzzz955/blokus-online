name: CI/CD Pipeline - Smart Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ ÌóàÏö©

env:
  # RepositoryÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò Ï£ºÏûÖ
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  
  # ÏÑúÎ≤Ñ ÏÑ§Ï†ï
  DEPLOY_PATH: /home/${{ secrets.SSH_USER }}/blokus-online
  DOCKER_COMPOSE_FILE: docker-compose.yml

jobs:
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      game-server-changed: ${{ steps.changes.outputs.game-server }}
      web-changed: ${{ steps.changes.outputs.web }}
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure }}
    
    steps:
    - name: Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏÜåÏä§ÏΩîÎìú
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Í∞êÏßÄ
      id: changes
      run: |
        # Ïù¥Ï†Ñ Ïª§Î∞ãÍ≥º ÌòÑÏû¨ Ïª§Î∞ã Í∞Ñ Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        if [ "${{ github.event_name }}" = "push" ]; then
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # ÏÉàÎ°úÏö¥ Î∏åÎûúÏπòÏù∏ Í≤ΩÏö∞ Î™®Îì† ÌååÏùºÏùÑ Î≥ÄÍ≤ΩÎêú Í≤ÉÏúºÎ°ú Í∞ÑÏ£º
            CHANGED_FILES=$(git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
        else
          # workflow_dispatchÏùò Í≤ΩÏö∞ Î™®Îì† ÏÑúÎπÑÏä§ ÎπåÎìú
          CHANGED_FILES=$(git ls-files)
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Í≤åÏûÑ ÏÑúÎ≤Ñ Í¥ÄÎ†® Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï≤¥ÌÅ¨
        GAME_SERVER_CHANGED=false
        if echo "$CHANGED_FILES" | grep -E '^(server/|client/|common/|proto/|CMakeLists\.txt|vcpkg\.json)'; then
          GAME_SERVER_CHANGED=true
        fi
        
        # Ïõπ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Í¥ÄÎ†® Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï≤¥ÌÅ¨
        WEB_CHANGED=false
        if echo "$CHANGED_FILES" | grep -E '^web/'; then
          WEB_CHANGED=true
        fi
        
        # Ïù∏ÌîÑÎùº Í¥ÄÎ†® Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï≤¥ÌÅ¨
        INFRASTRUCTURE_CHANGED=false
        if echo "$CHANGED_FILES" | grep -E '^(docker-compose\.yml|\.github/|\.env\.example)'; then
          INFRASTRUCTURE_CHANGED=true
        fi
        
        # Ïù∏ÌîÑÎùº Î≥ÄÍ≤ΩÏù¥ ÏûàÏúºÎ©¥ Î™®Îì† ÏÑúÎπÑÏä§ Ïû¨ÎπåÎìú
        if [ "$INFRASTRUCTURE_CHANGED" = "true" ]; then
          GAME_SERVER_CHANGED=true
          WEB_CHANGED=true
        fi
        
        echo "game-server=$GAME_SERVER_CHANGED" >> $GITHUB_OUTPUT
        echo "web=$WEB_CHANGED" >> $GITHUB_OUTPUT
        echo "infrastructure=$INFRASTRUCTURE_CHANGED" >> $GITHUB_OUTPUT
        
        echo "Game Server Changed: $GAME_SERVER_CHANGED"
        echo "Web Changed: $WEB_CHANGED"
        echo "Infrastructure Changed: $INFRASTRUCTURE_CHANGED"

  shared-setup:
    name: Shared Setup (Common Tasks)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.game-server-changed == 'true' || 
      needs.detect-changes.outputs.web-changed == 'true' || 
      needs.detect-changes.outputs.infrastructure-changed == 'true'
    
    steps:
    - name: Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏÜåÏä§ÏΩîÎìú
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH ÌÇ§ ÏÑ§Ï†ï
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "echo 'Shared setup - Connection successful!'"
        
    - name: Í≥µÌÜµ ÏÜåÏä§ÏΩîÎìú ÎèôÍ∏∞Ìôî
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          mkdir -p ${{ env.DEPLOY_PATH }} && 
          cd ${{ env.DEPLOY_PATH }} && 
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git fetch origin main &&
            git reset --hard origin/main
          fi
        "
        
    - name: Í≥µÌÜµ ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÏÉùÏÑ± (Ïù∏ÌîÑÎùº Î≥ÄÍ≤ΩÏãúÏóêÎßå)
      if: needs.detect-changes.outputs.infrastructure-changed == 'true'
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \\
          
          # ÌôòÍ≤ΩÎ≥ÄÏàò Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
          JWT_SECRET='${{ secrets.JWT_SECRET }}'
          SESSION_TIMEOUT_HOURS='${{ secrets.SESSION_TIMEOUT_HOURS }}'
          PASSWORD_SALT_ROUNDS='${{ secrets.PASSWORD_SALT_ROUNDS }}'
          LOG_LEVEL='${{ secrets.LOG_LEVEL }}'
          LOG_DIRECTORY='${{ secrets.LOG_DIRECTORY }}'
          DEBUG_MODE='${{ secrets.DEBUG_MODE }}'
          ENABLE_SQL_LOGGING='${{ secrets.ENABLE_SQL_LOGGING }}'
          
          # JWT ÏãúÌÅ¨Î¶ø ÏûêÎèô ÏÉùÏÑ± (ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞)
          if [ -z \\\"\\\$JWT_SECRET\\\" ]; then
            JWT_SECRET=\\\$(openssl rand -hex 32)
            echo 'WARNING: JWT_SECRET not set, auto-generated. Please set it in Repository Secrets for security!'
          fi
          
          cat > .env << EOF
        # =========================
        # Í≤åÏûÑ ÏÑúÎ≤Ñ ÏÑ§Ï†ï
        # =========================
        SERVER_PORT=${{ secrets.SERVER_PORT }}
        SERVER_MAX_CLIENTS=${{ secrets.SERVER_MAX_CLIENTS }}
        SERVER_THREAD_POOL_SIZE=${{ secrets.SERVER_THREAD_POOL_SIZE }}
        BLOKUS_SERVER_VERSION=${{ secrets.BLOKUS_SERVER_VERSION }}
        BLOKUS_DOWNLOAD_URL=${{ secrets.BLOKUS_DOWNLOAD_URL }}
        
        # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï (Í≤åÏûÑ ÏÑúÎ≤ÑÏö©)
        DB_HOST=postgres
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}
        
        # PostgreSQL ÏÑ§Ï†ï
        POSTGRES_DB=${{ secrets.DB_NAME }}
        POSTGRES_USER=${{ secrets.DB_USER }}
        POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # Î≥¥Ïïà ÏÑ§Ï†ï
        JWT_SECRET=\\\$JWT_SECRET
        SESSION_TIMEOUT_HOURS=\\\${SESSION_TIMEOUT_HOURS:-24}
        PASSWORD_SALT_ROUNDS=\\\${PASSWORD_SALT_ROUNDS:-12}
        
        # Î°úÍπÖ ÏÑ§Ï†ï
        LOG_LEVEL=\\\${LOG_LEVEL:-info}
        LOG_DIRECTORY=\\\${LOG_DIRECTORY:-/app/logs}
        
        # Í∞úÎ∞ú ÏÑ§Ï†ï
        DEBUG_MODE=\\\${DEBUG_MODE:-false}
        ENABLE_SQL_LOGGING=\\\${ENABLE_SQL_LOGGING:-false}
        
        # =========================
        # Ïõπ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏÑ§Ï†ï
        # =========================
        WEB_PORT=${{ secrets.WEB_PORT }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL }}
        WEB_CLIENT_DOWNLOAD_URL=${{ secrets.WEB_CLIENT_DOWNLOAD_URL }}
        
        # Ïõπ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï (ÎèôÏùºÌïú PostgreSQL Ïª®ÌÖåÏù¥ÎÑà, Îã§Î•∏ DBÎ™Ö)
        WEB_DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/blokus_web
        
        # Ïõπ Ïù∏Ï¶ù ÏÑ§Ï†ï
        WEB_NEXTAUTH_SECRET=${{ secrets.WEB_NEXTAUTH_SECRET }}
        WEB_JWT_SECRET=${{ secrets.WEB_JWT_SECRET }}
        
        # Ïõπ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ï
        WEB_ADMIN_USERNAME=${{ secrets.WEB_ADMIN_USERNAME }}
        WEB_ADMIN_PASSWORD=${{ secrets.WEB_ADMIN_PASSWORD }}
        
        # SSL/ÎèÑÎ©îÏù∏ ÏÑ§Ï†ï
        DOMAIN=${{ secrets.DOMAIN }}
        CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}
        EOF
        "
        
    - name: Í≥µÌÜµ ÎîîÎ†âÌÜ†Î¶¨ ÏÑ§Ï†ï (Ïù∏ÌîÑÎùº Î≥ÄÍ≤ΩÏãúÏóêÎßå)
      if: needs.detect-changes.outputs.infrastructure-changed == 'true'
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \\
          
          # Í∏∞Î≥∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p downloads web/uploads certbot/conf certbot/www && \\
          
          # logs ÎîîÎ†âÌÜ†Î¶¨ Í∞ïÏ†ú Ï†ïÎ¶¨ Î∞è Ïû¨ÏÉùÏÑ±
          rm -rf logs 2>/dev/null || echo 'logs cleanup completed' && \\
          mkdir -p logs/nginx && \\
          
          # Í∂åÌïú ÏÑ§Ï†ï
          chmod 755 downloads web/uploads logs logs/nginx certbot/conf certbot/www && \\
          echo 'All directories created and configured successfully'
        "

  deploy-game-server:
    name: Deploy Game Server
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup]
    if: needs.detect-changes.outputs.game-server-changed == 'true'
    
    steps:
    - name: SSH ÌÇ§ ÏÑ§Ï†ï
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Í≤åÏûÑ ÏÑúÎ≤Ñ ÎπåÎìú Î∞è Ïû¨ÏãúÏûë
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          export DOCKER_BUILDKIT=1 && 
          export COMPOSE_DOCKER_CLI_BUILD=1 && 
          docker compose stop blokus-server && 
          docker compose build blokus-server && 
          docker compose up -d blokus-server --wait --wait-timeout 60
        "

  deploy-web:
    name: Deploy Web Application
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup]
    if: needs.detect-changes.outputs.web-changed == 'true'
    
    steps:
    - name: SSH ÌÇ§ ÏÑ§Ï†ï
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Ïõπ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÎπåÎìú Î∞è Ïû¨ÏãúÏûë
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          export DOCKER_BUILDKIT=1 && 
          export COMPOSE_DOCKER_CLI_BUILD=1 && 
          docker compose stop blokus-web && 
          docker compose build blokus-web && 
          docker compose up -d blokus-web --wait --wait-timeout 60
        "

  deploy-full:
    name: Full Deploy (Infrastructure Changes)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure-changed == 'true'
    
    steps:
    - name: Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏÜåÏä§ÏΩîÎìú
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH ÌÇ§ ÏÑ§Ï†ï
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: ÌïÑÏàò ÌôòÍ≤ΩÎ≥ÄÏàò Ï≤¥ÌÅ¨
      run: |
        # ÌïÑÏàò secrets Ï≤¥ÌÅ¨
        if [ -z "${{ secrets.SSH_HOST }}" ] || [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_KEY }}" ]; then
          echo "ERROR: Required SSH connection information is missing!"
          echo "Required Repository Secrets: SSH_HOST, SSH_USER, SSH_KEY, SSH_PORT"
          exit 1
        fi
        
        if [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASSWORD }}" ] || [ -z "${{ secrets.DB_NAME }}" ]; then
          echo "ERROR: Required database information is missing!"
          echo "Required Repository Secrets: DB_USER, DB_PASSWORD, DB_NAME"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_PORT }}" ]; then
          echo "ERROR: Server port is not configured!"
          echo "Required Repository Secret: SERVER_PORT"
          exit 1
        fi
        
        # Ïõπ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÌôòÍ≤ΩÎ≥ÄÏàò Ï≤¥ÌÅ¨
        if [ -z "${{ secrets.WEB_APP_URL }}" ]; then
          echo "ERROR: Required web application information is missing!"
          echo "Required Repository Secrets: WEB_APP_URL"
          exit 1
        fi
        
        if [ -z "${{ secrets.WEB_ADMIN_USERNAME }}" ] || [ -z "${{ secrets.WEB_ADMIN_PASSWORD }}" ]; then
          echo "ERROR: Web admin account information is missing!"
          echo "Required Repository Secrets: WEB_ADMIN_USERNAME, WEB_ADMIN_PASSWORD"
          exit 1
        fi
        
        echo "Required environment variables check completed"
        
    - name: ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "echo 'Server connection successful!'"
        
    - name: ÏÑúÎ≤ÑÏóê ÏÜåÏä§ÏΩîÎìú Î∞∞Ìè¨
      run: |
        # Î∞∞Ìè¨ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
        
        # Git Ï†ÄÏû•ÏÜå Ï¥àÍ∏∞Ìôî ÎòêÎäî ÏóÖÎç∞Ïù¥Ìä∏
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git fetch origin main
            git reset --hard origin/main
          fi
        "
        
    - name: ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          
          # ÌôòÍ≤ΩÎ≥ÄÏàò Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
          JWT_SECRET='${{ secrets.JWT_SECRET }}'
          SESSION_TIMEOUT_HOURS='${{ secrets.SESSION_TIMEOUT_HOURS }}'
          PASSWORD_SALT_ROUNDS='${{ secrets.PASSWORD_SALT_ROUNDS }}'
          LOG_LEVEL='${{ secrets.LOG_LEVEL }}'
          LOG_DIRECTORY='${{ secrets.LOG_DIRECTORY }}'
          DEBUG_MODE='${{ secrets.DEBUG_MODE }}'
          ENABLE_SQL_LOGGING='${{ secrets.ENABLE_SQL_LOGGING }}'
          
          # JWT ÏãúÌÅ¨Î¶ø ÏûêÎèô ÏÉùÏÑ± (ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞)
          if [ -z \"\$JWT_SECRET\" ]; then
            JWT_SECRET=\$(openssl rand -hex 32)
            echo 'WARNING: JWT_SECRET not set, auto-generated. Please set it in Repository Secrets for security!'
          fi
          
          cat > .env << EOF
        # =========================
        # Í≤åÏûÑ ÏÑúÎ≤Ñ ÏÑ§Ï†ï
        # =========================
        SERVER_PORT=${{ secrets.SERVER_PORT }}
        SERVER_MAX_CLIENTS=${{ secrets.SERVER_MAX_CLIENTS }}
        SERVER_THREAD_POOL_SIZE=${{ secrets.SERVER_THREAD_POOL_SIZE }}
        BLOKUS_SERVER_VERSION=${{ secrets.BLOKUS_SERVER_VERSION }}
        BLOKUS_DOWNLOAD_URL=${{ secrets.BLOKUS_DOWNLOAD_URL }}
        
        # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï (Í≤åÏûÑ ÏÑúÎ≤ÑÏö©)
        DB_HOST=postgres
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}
        
        # PostgreSQL ÏÑ§Ï†ï
        POSTGRES_DB=${{ secrets.DB_NAME }}
        POSTGRES_USER=${{ secrets.DB_USER }}
        POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # Î≥¥Ïïà ÏÑ§Ï†ï
        JWT_SECRET=\$JWT_SECRET
        SESSION_TIMEOUT_HOURS=\${SESSION_TIMEOUT_HOURS:-24}
        PASSWORD_SALT_ROUNDS=\${PASSWORD_SALT_ROUNDS:-12}
        
        # Î°úÍπÖ ÏÑ§Ï†ï
        LOG_LEVEL=\${LOG_LEVEL:-info}
        LOG_DIRECTORY=\${LOG_DIRECTORY:-/app/logs}
        
        # Í∞úÎ∞ú ÏÑ§Ï†ï
        DEBUG_MODE=\${DEBUG_MODE:-false}
        ENABLE_SQL_LOGGING=\${ENABLE_SQL_LOGGING:-false}
        
        # =========================
        # Ïõπ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏÑ§Ï†ï
        # =========================
        WEB_PORT=${{ secrets.WEB_PORT }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL }}
        WEB_CLIENT_DOWNLOAD_URL=${{ secrets.WEB_CLIENT_DOWNLOAD_URL }}
        
        # Ïõπ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï (ÎèôÏùºÌïú PostgreSQL Ïª®ÌÖåÏù¥ÎÑà, Îã§Î•∏ DBÎ™Ö)
        WEB_DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/blokus_web
        
        # Ïõπ Ïù∏Ï¶ù ÏÑ§Ï†ï
        WEB_NEXTAUTH_SECRET=${{ secrets.WEB_NEXTAUTH_SECRET }}
        WEB_JWT_SECRET=${{ secrets.WEB_JWT_SECRET }}
        
        # Ïõπ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ï
        WEB_ADMIN_USERNAME=${{ secrets.WEB_ADMIN_USERNAME }}
        WEB_ADMIN_PASSWORD=${{ secrets.WEB_ADMIN_PASSWORD }}
        
        # SSL/ÎèÑÎ©îÏù∏ ÏÑ§Ï†ï
        DOMAIN=${{ secrets.DOMAIN }}
        CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}
        EOF
        "
        
    - name: ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Îã§Ïö¥Î°úÎìú ÎîîÎ†âÌÜ†Î¶¨ ÏÑ§Ï†ï
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          
          # Í∏∞Î≥∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p downloads web/uploads certbot/conf certbot/www && \
          
          # logs ÎîîÎ†âÌÜ†Î¶¨ Í∞ïÏ†ú Ï†ïÎ¶¨ Î∞è Ïû¨ÏÉùÏÑ±
          rm -rf logs 2>/dev/null || echo 'logs cleanup completed' && \
          mkdir -p logs/nginx && \
          
          # Í∂åÌïú ÏÑ§Ï†ï
          chmod 755 downloads web/uploads logs logs/nginx certbot/conf certbot/www && \
          echo 'All directories created and configured successfully'
        "
          
    - name: Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          docker compose down
        "
        
    - name: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Î∞∞Ìè¨
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          export DOCKER_BUILDKIT=1 && \
          export COMPOSE_DOCKER_CLI_BUILD=1 && \
          docker compose build --parallel && \
          docker compose up -d --wait --wait-timeout 60
        "
        
        
    - name: Î∞∞Ìè¨ Í≤∞Í≥º ÏïåÎ¶º
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "Full infrastructure deployment successful!"
          echo "Game Server: ${{ secrets.WEB_APP_URL }}:${{ secrets.SERVER_PORT }}"
          echo "Website: https://${{ secrets.WEB_APP_URL }}"
          echo "Client Download Directory: ${{ env.DEPLOY_PATH }}/downloads"
        else
          echo "Full infrastructure deployment failed!"
        fi
        
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, shared-setup, deploy-game-server, deploy-web, deploy-full]
    if: always()
    
    steps:
    - name: Î∞∞Ìè¨ Í≤∞Í≥º ÏöîÏïΩ
      run: |
        echo "=== Smart Deployment Summary ==="
        echo ""
        
        # Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Í∞êÏßÄ Í≤∞Í≥º
        echo "üìä Changes Detected:"
        echo "  - Game Server: ${{ needs.detect-changes.outputs.game-server-changed }}"
        echo "  - Web Application: ${{ needs.detect-changes.outputs.web-changed }}"
        echo "  - Infrastructure: ${{ needs.detect-changes.outputs.infrastructure-changed }}"
        echo ""
        
        # Í∞úÎ≥Ñ Î∞∞Ìè¨ Í≤∞Í≥º
        echo "üöÄ Deployment Results:"
        
        if [ "${{ needs.detect-changes.outputs.game-server-changed }}" = "true" ]; then
          if [ "${{ needs.deploy-game-server.result }}" = "success" ]; then
            echo "  ‚úÖ Game Server: Successfully deployed"
          else
            echo "  ‚ùå Game Server: Deployment failed"
          fi
        else
          echo "  ‚è≠Ô∏è Game Server: Skipped (no changes)"
        fi
        
        if [ "${{ needs.detect-changes.outputs.web-changed }}" = "true" ]; then
          if [ "${{ needs.deploy-web.result }}" = "success" ]; then
            echo "  ‚úÖ Web Application: Successfully deployed"
          else
            echo "  ‚ùå Web Application: Deployment failed"
          fi
        else
          echo "  ‚è≠Ô∏è Web Application: Skipped (no changes)"
        fi
        
        if [ "${{ needs.detect-changes.outputs.infrastructure-changed }}" = "true" ]; then
          if [ "${{ needs.deploy-full.result }}" = "success" ]; then
            echo "  ‚úÖ Full Infrastructure: Successfully deployed"
          else
            echo "  ‚ùå Full Infrastructure: Deployment failed"
          fi
        else
          echo "  ‚è≠Ô∏è Full Infrastructure: Skipped (no changes)"
        fi
        
        echo ""
        echo "üåê Service URLs:"
        echo "  - Game Server: ${{ secrets.WEB_APP_URL }}:${{ secrets.SERVER_PORT }}"
        echo "  - Website: https://${{ secrets.WEB_APP_URL }}"
        
        # Ï†ÑÏ≤¥ ÏÑ±Í≥µ Ïó¨Î∂Ä Ï≤¥ÌÅ¨
        OVERALL_SUCCESS=true
        
        if [ "${{ needs.detect-changes.outputs.game-server-changed }}" = "true" ] && [ "${{ needs.deploy-game-server.result }}" != "success" ]; then
          OVERALL_SUCCESS=false
        fi
        
        if [ "${{ needs.detect-changes.outputs.web-changed }}" = "true" ] && [ "${{ needs.deploy-web.result }}" != "success" ]; then
          OVERALL_SUCCESS=false
        fi
        
        if [ "${{ needs.detect-changes.outputs.infrastructure-changed }}" = "true" ] && [ "${{ needs.deploy-full.result }}" != "success" ]; then
          OVERALL_SUCCESS=false
        fi
        
        echo ""
        if [ "$OVERALL_SUCCESS" = "true" ]; then
          echo "üéâ Smart deployment completed successfully!"
          exit 0
        else
          echo "üí• Some deployments failed!"
          exit 1
        fi