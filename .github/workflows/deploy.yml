name: CI/CD Pipeline - Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  # Repositoryì—ì„œ í™˜ê²½ë³€ìˆ˜ ì£¼ìž…
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  
  # ì„œë²„ ì„¤ì •
  DEPLOY_PATH: /home/${{ secrets.SSH_USER }}/blokus-online
  DOCKER_COMPOSE_FILE: docker-compose.yml

jobs:
  deploy:
    name: Deploy to Ubuntu Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ ì†ŒìŠ¤ì½”ë“œ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
      run: |
        # í•„ìˆ˜ secrets ì²´í¬
        if [ -z "${{ secrets.SSH_HOST }}" ] || [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_KEY }}" ]; then
          echo "âŒ í•„ìˆ˜ SSH ì—°ê²° ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "í•„ìš”í•œ Repository Secrets: SSH_HOST, SSH_USER, SSH_KEY, SSH_PORT"
          exit 1
        fi
        
        if [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASSWORD }}" ] || [ -z "${{ secrets.DB_NAME }}" ]; then
          echo "âŒ í•„ìˆ˜ ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "í•„ìš”í•œ Repository Secrets: DB_USER, DB_PASSWORD, DB_NAME"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_PORT }}" ]; then
          echo "âŒ ì„œë²„ í¬íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
          echo "í•„ìš”í•œ Repository Secret: SERVER_PORT"
          exit 1
        fi
        
        # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
        if [ -z "${{ secrets.WEB_APP_URL }}" ]; then
          echo "âŒ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "í•„ìš”í•œ Repository Secrets: WEB_APP_URL"
          exit 1
        fi
        
        if [ -z "${{ secrets.WEB_ADMIN_USERNAME }}" ] || [ -z "${{ secrets.WEB_ADMIN_PASSWORD }}" ]; then
          echo "âŒ ì›¹ ê´€ë¦¬ìž ê³„ì • ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "í•„ìš”í•œ Repository Secrets: WEB_ADMIN_USERNAME, WEB_ADMIN_PASSWORD"
          exit 1
        fi
        
        echo "âœ… í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬ ì™„ë£Œ"
        
    - name: ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "echo 'ì„œë²„ ì—°ê²° ì„±ê³µ!'"
        
    - name: ì„œë²„ì— ì†ŒìŠ¤ì½”ë“œ ë°°í¬
      run: |
        # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
        
        # Git ì €ìž¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && 
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git fetch origin main
            git reset --hard origin/main
          fi
        "
        
    - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          
          # í™˜ê²½ë³€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì •
          JWT_SECRET='${{ secrets.JWT_SECRET }}'
          SESSION_TIMEOUT_HOURS='${{ secrets.SESSION_TIMEOUT_HOURS }}'
          PASSWORD_SALT_ROUNDS='${{ secrets.PASSWORD_SALT_ROUNDS }}'
          LOG_LEVEL='${{ secrets.LOG_LEVEL }}'
          LOG_DIRECTORY='${{ secrets.LOG_DIRECTORY }}'
          DEBUG_MODE='${{ secrets.DEBUG_MODE }}'
          ENABLE_SQL_LOGGING='${{ secrets.ENABLE_SQL_LOGGING }}'
          
          # JWT ì‹œí¬ë¦¿ ìžë™ ìƒì„± (ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°)
          if [ -z \"\$JWT_SECRET\" ]; then
            JWT_SECRET=\$(openssl rand -hex 32)
            echo 'âš ï¸ JWT_SECRETê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìžë™ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ Repository Secretì— ì„¤ì •í•˜ì„¸ìš”!'
          fi
          
          cat > .env << EOF
        # =========================
        # ê²Œìž„ ì„œë²„ ì„¤ì •
        # =========================
        SERVER_PORT=${{ secrets.SERVER_PORT }}
        SERVER_MAX_CLIENTS=${{ secrets.SERVER_MAX_CLIENTS }}
        SERVER_THREAD_POOL_SIZE=${{ secrets.SERVER_THREAD_POOL_SIZE }}
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ê²Œìž„ ì„œë²„ìš©)
        DB_HOST=postgres
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}
        
        # PostgreSQL ì„¤ì •
        POSTGRES_DB=${{ secrets.DB_NAME }}
        POSTGRES_USER=${{ secrets.DB_USER }}
        POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # ë³´ì•ˆ ì„¤ì •
        JWT_SECRET=\$JWT_SECRET
        SESSION_TIMEOUT_HOURS=\${SESSION_TIMEOUT_HOURS:-24}
        PASSWORD_SALT_ROUNDS=\${PASSWORD_SALT_ROUNDS:-12}
        
        # ë¡œê¹… ì„¤ì •
        LOG_LEVEL=\${LOG_LEVEL:-info}
        LOG_DIRECTORY=\${LOG_DIRECTORY:-/app/logs}
        
        # ê°œë°œ ì„¤ì •
        DEBUG_MODE=\${DEBUG_MODE:-false}
        ENABLE_SQL_LOGGING=\${ENABLE_SQL_LOGGING:-false}
        
        # =========================
        # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
        # =========================
        WEB_PORT=${{ secrets.WEB_PORT }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL }}
        WEB_CLIENT_DOWNLOAD_URL=${{ secrets.WEB_CLIENT_DOWNLOAD_URL }}
        
        # ì›¹ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ë™ì¼í•œ PostgreSQL ì»¨í…Œì´ë„ˆ, ë‹¤ë¥¸ DBëª…)
        WEB_DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/blokus_web
        
        # ì›¹ ì¸ì¦ ì„¤ì •
        WEB_NEXTAUTH_SECRET=${{ secrets.WEB_NEXTAUTH_SECRET }}
        WEB_JWT_SECRET=${{ secrets.WEB_JWT_SECRET }}
        
        # ì›¹ ê´€ë¦¬ìž ê³„ì •
        WEB_ADMIN_USERNAME=${{ secrets.WEB_ADMIN_USERNAME }}
        WEB_ADMIN_PASSWORD=${{ secrets.WEB_ADMIN_PASSWORD }}
        EOF
        "
        
    - name: í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬ ì„¤ì •
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          
          # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p downloads web/uploads logs/nginx certbot/conf certbot/www && \
          
          # ê¶Œí•œ ì„¤ì • (Dockerì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
          chmod 755 downloads web/uploads logs/nginx && \
          chmod 755 certbot/conf certbot/www && \
          
          # ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬ ì•ˆë‚´ íŒŒì¼ ìƒì„±
          cat > downloads/README.md << 'DOWNLOAD_EOF'
# Blokus Online Client Downloads

ì´ ë””ë ‰í† ë¦¬ëŠ” í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ íŒŒì¼ì„ ìœ„í•œ ê³µê°„ìž…ë‹ˆë‹¤.

## íŒŒì¼ ì—…ë¡œë“œ ë°©ë²•
1. Windowsì—ì„œ ë¹Œë“œëœ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì´ ë””ë ‰í† ë¦¬ì— ì—…ë¡œë“œ
2. íŒŒì¼ëª…: BlokusClient-latest.zip (ìµœì‹  ë²„ì „)
3. nginxë¥¼ í†µí•´ https://blokus-online.mooo.com/downloads/ ê²½ë¡œë¡œ ì œê³µë©ë‹ˆë‹¤.

## ë””ë ‰í† ë¦¬ êµ¬ì¡°
- BlokusClient-latest.zip (ì‹¬ë³¼ë¦­ ë§í¬ ë˜ëŠ” ìµœì‹  íŒŒì¼)
- BlokusClient-v1.0.0.zip (ë²„ì „ë³„ íŒŒì¼)
- BlokusClient-v1.0.1.zip
- ...
DOWNLOAD_EOF
          
          echo 'âœ… í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬ ì„¤ì • ì™„ë£Œ'
        "
        
    - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          docker compose down --remove-orphans || true && \
          docker image prune -f --filter label=stage=intermediate || true
        "
        
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          cd ${{ env.DEPLOY_PATH }} && \
          export DOCKER_BUILDKIT=1 && \
          export COMPOSE_DOCKER_CLI_BUILD=1 && \
          docker compose build --parallel && \
          docker compose up -d --wait --wait-timeout 60
        "
        
        
    - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… ë°°í¬ ì„±ê³µ!"
          echo "ðŸŽ® ê²Œìž„ ì„œë²„: ${{ secrets.WEB_APP_URL }}:${{ secrets.SERVER_PORT }}"
          echo "ðŸŒ ì›¹ì‚¬ì´íŠ¸: https://${{ secrets.WEB_APP_URL }}"
          echo "ðŸ“ í´ë¼ì´ì–¸íŠ¸ ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬: ${{ env.DEPLOY_PATH }}/downloads"
        else
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
        fi