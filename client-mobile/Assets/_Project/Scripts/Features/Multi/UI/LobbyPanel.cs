using UnityEngine;
using UnityEngine.UI;
using System.Collections.Generic;
using Features.Multi.Net;
using Features.Multi.Core;
using Features.Multi.Models;
using App.UI;
using TMPro;
using NetRoomInfo = Features.Multi.Net.RoomInfo;
using NetUserInfo = Features.Multi.Net.UserInfo;
using SharedRoomInfo = Shared.Models.RoomInfo;
using SharedUserInfo = Shared.Models.UserInfo;

namespace Features.Multi.UI
{
    /// <summary>
    /// Î°úÎπÑ Ìå®ÎÑê - Qt LobbyWindowÏôÄ ÎèôÏùºÌïú Í∏∞Îä•
    /// Ï†ëÏÜçÏûê Î™©Î°ù, Î∞© Î™©Î°ù, Ï±ÑÌåÖ, Î∞© ÏÉùÏÑ±/Ï∞∏Í∞Ä Í∏∞Îä•
    /// </summary>
    public class LobbyPanel : MonoBehaviour
    {
        [Header("Info Panel")]
        [SerializeField] private TextMeshProUGUI welcomeLabel;
        [SerializeField] private TextMeshProUGUI userStatsLabel;
        [SerializeField] private Button settingsButton;
        [SerializeField] private Button logoutButton;

        [Header("Left Panel - Users & Ranking")]
        [SerializeField] private TabGroup leftTabs;
        [SerializeField] private Transform usersTab;
        [SerializeField] private Transform rankingTab;
        [SerializeField] private TextMeshProUGUI onlineCountLabel;
        [SerializeField] private ScrollRect userListScrollRect;
        [SerializeField] private Transform userListContent;
        [SerializeField] private GameObject userItemPrefab;
        [SerializeField] private ScrollRect rankingScrollRect;
        [SerializeField] private Transform rankingContent;
        [SerializeField] private GameObject rankingItemPrefab;

        [Header("Center Panel - Rooms")]
        [SerializeField] private ScrollRect roomListScrollRect;
        [SerializeField] private Transform roomListContent;
        [SerializeField] private GameObject roomItemPrefab;
        [SerializeField] private Button createRoomButton;
        [SerializeField] private Button joinRoomButton;
        [SerializeField] private Button refreshRoomButton;

        [Header("Right Panel - Chat")]
        [SerializeField] private ScrollRect chatScrollRect;
        [SerializeField] private TextMeshProUGUI chatDisplay;
        [SerializeField] private TMP_InputField chatInput;
        [SerializeField] private Button chatSendButton;

        [Header("Create Room Panel")]
        [SerializeField] private CreateRoomPanel createRoomPanel;

        // Dependencies
        private NetworkManager networkManager;
        private MultiUserDataCache dataCache;

        // Data
        private List<NetUserInfo> onlineUsers = new List<NetUserInfo>();
        private List<NetUserInfo> rankingData = new List<NetUserInfo>();
        private List<NetRoomInfo> roomList = new List<NetRoomInfo>();
        private List<ChatMessage> chatHistory = new List<ChatMessage>();
        
        // State
        private int selectedRoomId = -1;
        private bool isInitialized = false;

        // ========================================
        // Lifecycle
        // ========================================

        void Start()
        {
            Initialize();
        }

        void OnDestroy()
        {
            Cleanup();
        }

        // ========================================
        // Initialization
        // ========================================

        private void Initialize()
        {
            FindDependencies();
            SetupUI();
            SubscribeToEvents();
            
            // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            RefreshAllData();
            
            isInitialized = true;
            Debug.Log("[LobbyPanel] Initialized successfully");
        }

        private void FindDependencies()
        {
            networkManager = NetworkManager.Instance;
            dataCache = MultiUserDataCache.Instance;

            if (networkManager == null)
                Debug.LogError("[LobbyPanel] NetworkManager not found!");

            if (dataCache == null)
                Debug.LogError("[LobbyPanel] MultiUserDataCache not found!");
        }

        private void SetupUI()
        {
            // CreateRoomPanel Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
            if (createRoomPanel != null)
            {
                createRoomPanel.OnRoomCreated += OnRoomCreated;
                createRoomPanel.OnCancelled += OnRoomCreationCancelled;
            }

            // Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
            if (createRoomButton != null)
                createRoomButton.onClick.AddListener(OnCreateRoomButtonClicked);

            if (joinRoomButton != null)
                joinRoomButton.onClick.AddListener(OnJoinRoomButtonClicked);

            if (refreshRoomButton != null)
                refreshRoomButton.onClick.AddListener(OnRefreshButtonClicked);

            if (settingsButton != null)
                settingsButton.onClick.AddListener(OnSettingsButtonClicked);

            if (logoutButton != null)
                logoutButton.onClick.AddListener(OnLogoutButtonClicked);

            if (chatSendButton != null)
                chatSendButton.onClick.AddListener(OnChatSendButtonClicked);

            if (chatInput != null)
                chatInput.onEndEdit.AddListener(OnChatInputEndEdit);

            // Î∞© ÏÉùÏÑ± Ìå®ÎÑê Ïù¥Î≤§Ìä∏
            if (createRoomPanel != null)
            {
                createRoomPanel.OnRoomCreated += OnRoomCreatedFromPanel;
                createRoomPanel.OnCancelled += OnCreateRoomCancelled;
            }

            // Ï¥àÍ∏∞ UI ÏÉÅÌÉú ÏÑ§Ï†ï
            UpdateConnectionStatus();
            UpdateUserStatsDisplay();
        }

        private void SubscribeToEvents()
        {
            if (networkManager != null)
            {
                networkManager.OnConnectionChanged += OnConnectionChanged;
                networkManager.OnRoomListUpdated += OnRoomListUpdated;
                networkManager.OnRoomCreated += OnRoomCreated;
                networkManager.OnJoinRoomResponse += OnJoinRoomResponse;
                networkManager.OnChatMessage += OnChatMessageReceived;
                networkManager.OnErrorReceived += OnErrorReceived;
            }

            if (dataCache != null)
            {
                dataCache.OnOnlineUsersUpdated += OnOnlineUsersUpdated;
                dataCache.OnRankingUpdated += OnRankingUpdated;
                dataCache.OnUserDataUpdated += OnUserDataUpdated;
            }
        }

        private void Cleanup()
        {
            if (networkManager != null)
            {
                networkManager.OnConnectionChanged -= OnConnectionChanged;
                networkManager.OnRoomListUpdated -= OnRoomListUpdated;
                networkManager.OnRoomCreated -= OnRoomCreated;
                networkManager.OnJoinRoomResponse -= OnJoinRoomResponse;
                networkManager.OnChatMessage -= OnChatMessageReceived;
                networkManager.OnErrorReceived -= OnErrorReceived;
            }

            if (dataCache != null)
            {
                dataCache.OnOnlineUsersUpdated -= OnOnlineUsersUpdated;
                dataCache.OnRankingUpdated -= OnRankingUpdated;
                dataCache.OnUserDataUpdated -= OnUserDataUpdated;
            }
        }

        // ========================================
        // UI Updates
        // ========================================

        private void RefreshAllData()
        {
            if (networkManager != null)
            {
                // ÏÑúÎ≤ÑÏóê Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
                networkManager.EnterLobby();
                networkManager.RequestRoomList();
                networkManager.RequestOnlineUsers();
                networkManager.RequestRanking();
            }
        }

        private void UpdateConnectionStatus()
        {
            bool isConnected = networkManager?.IsConnected() ?? false;

            // Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
            if (createRoomButton != null)
                createRoomButton.interactable = isConnected;

            if (joinRoomButton != null)
                joinRoomButton.interactable = isConnected && selectedRoomId != -1;

            if (refreshRoomButton != null)
                refreshRoomButton.interactable = isConnected;

            if (chatSendButton != null)
                chatSendButton.interactable = isConnected;
        }

        private void UpdateUserStatsDisplay()
        {
            if (dataCache == null) return;

            SharedUserInfo myInfo = dataCache.GetMyUserInfo();
            if (myInfo != null)
            {
                if (welcomeLabel != null)
                    welcomeLabel.text = $"üéÆ {myInfo.display_name}Îãò, ÌôòÏòÅÌï©ÎãàÎã§!";

                if (userStatsLabel != null)
                {
                    userStatsLabel.text = $"Î†àÎ≤® {myInfo.level} | {myInfo.wins}Ïäπ {myInfo.losses}Ìå® | " +
                                        $"ÏäπÎ•† {myInfo.GetWinRate():F1}% | Í≤åÏûÑ {myInfo.totalGames}Ìöå";
                }
            }
        }

        private void UpdateOnlineUsersList()
        {
            if (userListContent == null || userItemPrefab == null) return;

            // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
            foreach (Transform child in userListContent)
            {
                Destroy(child.gameObject);
            }

            // ÏÉà ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
            var users = dataCache?.GetOnlineUsers();
            if (users != null)
            {
                onlineUsers = new List<NetUserInfo>();
                // Shared.Models.UserInfoÎ•º Features.Multi.Net.UserInfoÎ°ú Î≥ÄÌôò
                foreach (var user in users)
                {
                    var netUser = new NetUserInfo
                    {
                        username = user.username,
                        displayName = user.display_name,
                        level = user.level,
                        wins = user.wins,
                        losses = user.losses,
                        totalGames = user.totalGames,
                        isOnline = true
                    };
                    onlineUsers.Add(netUser);
                }
            }
            else
            {
                onlineUsers = new List<NetUserInfo>();
            }
            foreach (NetUserInfo user in onlineUsers)
            {
                GameObject userItem = Instantiate(userItemPrefab, userListContent);
                
                // UserItemUI Ïª¥Ìè¨ÎÑåÌä∏Ïóê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï (Íµ¨ÌòÑ ÌïÑÏöî)
                var userItemUI = userItem.GetComponent<UserItemUI>();
                if (userItemUI != null)
                {
                    userItemUI.SetupUser(user);
                }
            }

            // Ïò®ÎùºÏù∏ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            if (onlineCountLabel != null)
                onlineCountLabel.text = $"Ï†ëÏÜçÏûê ({onlineUsers.Count}Î™Ö)";
        }

        private void UpdateRankingList()
        {
            if (rankingContent == null || rankingItemPrefab == null) return;

            // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
            foreach (Transform child in rankingContent)
            {
                Destroy(child.gameObject);
            }

            // ÏÉà ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
            var ranking = dataCache?.GetRankingData();
            if (ranking != null)
            {
                for (int i = 0; i < ranking.Count; i++)
                {
                    GameObject rankingItem = Instantiate(rankingItemPrefab, rankingContent);
                    
                    // RankingItemUI Ïª¥Ìè¨ÎÑåÌä∏Ïóê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                    var rankingItemUI = rankingItem.GetComponent<RankingItemUI>();
                    if (rankingItemUI != null)
                    {
                        rankingItemUI.SetupRanking(ranking[i], i + 1);
                    }
                }
            }
        }

        private void UpdateRoomList()
        {
            if (roomListContent == null || roomItemPrefab == null) return;

            // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
            foreach (Transform child in roomListContent)
            {
                Destroy(child.gameObject);
            }

            // ÏÉà ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
            var rooms = dataCache?.GetRoomList();
            if (rooms != null)
            {
                foreach (var room in rooms)
                {
                    GameObject roomItem = Instantiate(roomItemPrefab, roomListContent);
                    
                    // RoomItemUI Ïª¥Ìè¨ÎÑåÌä∏Ïóê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï (Íµ¨ÌòÑ ÌïÑÏöî)
                    var roomItemUI = roomItem.GetComponent<RoomItemUI>();
                    if (roomItemUI != null)
                    {
                        roomItemUI.SetupRoom(room, null);
                    }
                }
            }
        }

        // ========================================
        // Event Handlers
        // ========================================

        private void OnCreateRoomButtonClicked()
        {
            Debug.Log("[LobbyPanel] Î∞© ÏÉùÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠");
            
            if (createRoomPanel != null)
            {
                createRoomPanel.Show();
            }
            else
            {
                Debug.LogError("[LobbyPanel] CreateRoomPanelÏù¥ Ìï†ÎãπÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            }
        }

        private void OnJoinRoomButtonClicked()
        {
            if (selectedRoomId != -1 && networkManager != null)
            {
                networkManager.JoinRoom(selectedRoomId);
            }
        }

        private void OnRefreshButtonClicked()
        {
            RefreshAllData();
        }

        private void OnSettingsButtonClicked()
        {
            // TODO: ÏÑ§Ï†ï Ï∞Ω Ïó¥Í∏∞
            Debug.Log("[LobbyPanel] Settings button clicked");
        }

        private void OnLogoutButtonClicked()
        {
            // TODO: Î°úÍ∑∏ÏïÑÏõÉ ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏
            Debug.Log("[LobbyPanel] Logout button clicked");
            
            // Î©îÏù∏ Ïî¨ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            var sceneController = GetComponentInParent<MultiGameplaySceneController>();
            if (sceneController != null)
            {
                sceneController.ReturnToMainScene();
            }
        }

        private void OnChatSendButtonClicked()
        {
            SendChatMessage();
        }

        private void OnChatInputEndEdit(string text)
        {
            if (Input.GetKeyDown(KeyCode.Return) || Input.GetKeyDown(KeyCode.KeypadEnter))
            {
                SendChatMessage();
            }
        }

        private void OnRoomCreatedFromPanel(RoomCreationInfo roomInfo)
        {
            if (string.IsNullOrEmpty(roomInfo.roomName))
            {
                ShowMessage("Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                return;
            }

            if (networkManager != null)
            {
                networkManager.CreateRoom(roomInfo.roomName, roomInfo.maxPlayers);
            }
        }

        private void OnCreateRoomCancelled()
        {
            // Î∞© ÏÉùÏÑ± Ï∑®ÏÜå Ïãú ÏïÑÎ¨¥ ÏûëÏóÖ ÏóÜÏùå (CreateRoomPanelÏù¥ ÏûêÏ≤¥Ï†ÅÏúºÎ°ú Îã´Ìûò)
        }

        // ========================================
        // Network Event Handlers
        // ========================================

        private void OnConnectionChanged(bool isConnected)
        {
            UpdateConnectionStatus();
            
            if (!isConnected)
            {
                ShowMessage("ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.");
            }
        }

        private void OnRoomListUpdated(List<NetRoomInfo> rooms)
        {
            UpdateRoomList();
        }

        private void OnRoomCreated(NetRoomInfo room)
        {
            ShowMessage($"Î∞© '{room.roomName}'Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.");
        }

        private void OnJoinRoomResponse(bool success, string message)
        {
            if (success)
            {
                ShowMessage("Î∞©Ïóê Ï∞∏Í∞ÄÌñàÏäµÎãàÎã§.");
                // GameRoomPanelÎ°ú Ï†ÑÌôòÏùÄ MultiGameplaySceneControllerÍ∞Ä Ï≤òÎ¶¨
            }
            else
            {
                ShowMessage($"Î∞© Ï∞∏Í∞Ä Ïã§Ìå®: {message}");
            }
        }

        private void OnChatMessageReceived(string message)
        {
            // Î©îÏãúÏßÄÎ•º ChatMessage Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
            ChatMessage chatMsg = new ChatMessage("Unknown", message, "Unknown");
            chatHistory.Add(chatMsg);
            UpdateChatDisplay();
        }

        private void OnErrorReceived(string error)
        {
            ShowMessage($"Ïò§Î•ò: {error}");
        }

        private void OnOnlineUsersUpdated()
        {
            UpdateOnlineUsersList();
        }

        private void OnRankingUpdated()
        {
            UpdateRankingList();
        }

        private void OnUserDataUpdated()
        {
            UpdateUserStatsDisplay();
        }

        // ========================================
        // Helper Methods
        // ========================================

        private void SendChatMessage()
        {
            if (chatInput == null || networkManager == null) return;

            string message = chatInput.text.Trim();
            if (string.IsNullOrEmpty(message)) return;

            networkManager.SendChatMessage(message);
            chatInput.text = "";
        }

        private void UpdateChatDisplay()
        {
            if (chatDisplay == null) return;

            System.Text.StringBuilder sb = new System.Text.StringBuilder();
            foreach (ChatMessage msg in chatHistory)
            {
                string timestamp = msg.timestamp.ToString("HH:mm");
                sb.AppendLine($"[{timestamp}] {msg.displayName}: {msg.message}");
            }

            chatDisplay.text = sb.ToString();

            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            if (chatScrollRect != null)
            {
                Canvas.ForceUpdateCanvases();
                chatScrollRect.verticalNormalizedPosition = 0f;
            }
        }

        private void ShowMessage(string message)
        {
            Debug.Log($"[LobbyPanel] {message}");
            // TODO: Toast Î©îÏãúÏßÄ ÌëúÏãú
        }

        // ========================================
        // Public API (for Room Item UI)
        // ========================================

        public void SelectRoom(int roomId)
        {
            selectedRoomId = roomId;
            UpdateConnectionStatus(); // joinRoomButton ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        }

        public void JoinRoom(int roomId)
        {
            selectedRoomId = roomId;
            OnJoinRoomButtonClicked();
        }

        // ========================================
        // CreateRoomPanel Event Handlers
        // ========================================

        /// <summary>
        /// Î∞© ÏÉùÏÑ± ÏöîÏ≤≠ Ï≤òÎ¶¨
        /// </summary>
        private void OnRoomCreated(RoomCreationInfo roomInfo)
        {
            Debug.Log($"[LobbyPanel] Î∞© ÏÉùÏÑ± ÏöîÏ≤≠: {roomInfo.roomName}");
            
            if (networkManager != null)
            {
                // TCP ÌîÑÎ°úÌÜ†ÏΩúÏùÑ ÌÜµÌï¥ Î∞© ÏÉùÏÑ± ÏöîÏ≤≠
                networkManager.CreateRoom(roomInfo.roomName, roomInfo.maxPlayers);
            }
            else
            {
                Debug.LogError("[LobbyPanel] NetworkManager not available for room creation");
                ShowMessage("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            }
        }

        /// <summary>
        /// Î∞© ÏÉùÏÑ± Ï∑®ÏÜå Ï≤òÎ¶¨
        /// </summary>
        private void OnRoomCreationCancelled()
        {
            Debug.Log("[LobbyPanel] Î∞© ÏÉùÏÑ± Ï∑®ÏÜå");
            // ÌäπÎ≥ÑÌïú Ï≤òÎ¶¨ ÏóÜÏù¥ Î°úÍ∑∏Îßå Ï∂úÎ†•
        }

        // ========================================
        // RoomItemUI Event Handlers
        // ========================================

        /// <summary>
        /// Î∞© ÏÑ†ÌÉù Ï≤òÎ¶¨
        /// </summary>
        private void OnRoomItemSelected(NetRoomInfo roomInfo)
        {
            selectedRoomId = roomInfo.roomId;
            Debug.Log($"[LobbyPanel] Î∞© ÏÑ†ÌÉù: {roomInfo.roomName} (ID: {roomInfo.roomId})");
            
            // ÏÑ†ÌÉùÎêú Î∞© UI ÏóÖÎç∞Ïù¥Ìä∏
            UpdateRoomSelection();
        }

        /// <summary>
        /// Î∞© ÎçîÎ∏îÌÅ¥Î¶≠ Ï≤òÎ¶¨ (Ï¶âÏãú Ï∞∏Í∞Ä)
        /// </summary>
        private void OnRoomItemDoubleClicked(NetRoomInfo roomInfo)
        {
            Debug.Log($"[LobbyPanel] Î∞© ÎçîÎ∏îÌÅ¥Î¶≠ Ï∞∏Í∞Ä: {roomInfo.roomName}");
            
            selectedRoomId = roomInfo.roomId;
            
            if (networkManager != null)
            {
                networkManager.JoinRoom(roomInfo.roomId);
            }
            else
            {
                Debug.LogError("[LobbyPanel] NetworkManager not available for room join");
                ShowMessage("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            }
        }

        /// <summary>
        /// ÏÑ†ÌÉùÎêú Î∞© UI ÏóÖÎç∞Ïù¥Ìä∏
        /// </summary>
        private void UpdateRoomSelection()
        {
            // Î∞© Î™©Î°ùÏóêÏÑú ÏÑ†ÌÉùÎêú Î∞©ÏùÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï≤òÎ¶¨
            if (roomListContent != null)
            {
                for (int i = 0; i < roomListContent.childCount; i++)
                {
                    var roomItem = roomListContent.GetChild(i).GetComponent<RoomItemUI>();
                    if (roomItem != null)
                    {
                        // ÏÑ†ÌÉù ÏÉÅÌÉúÎäî Í∞Å RoomItemUIÏóêÏÑú Í¥ÄÎ¶¨Îê®
                        // Ïó¨Í∏∞ÏÑúÎäî selectedRoomIdÏôÄ ÏùºÏπòÌïòÎäî Ìï≠Î™©Îßå ÏÑ†ÌÉù ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
                    }
                }
            }
        }
    }
}