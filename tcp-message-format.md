# TCP 메시지 프로토콜 명세서

## 개요

블로커스 온라인 게임의 TCP 통신 프로토콜 명세서입니다.
클라이언트(데스크탑/모바일)와 서버 간의 모든 메시지 형식을 정의합니다.

## 기본 프로토콜 규칙

- **인코딩**: UTF-8
- **구분자**: 콜론(:)
- **종료문자**: 라인 피드(\n)
- **기본 형식**: `메시지타입:파라미터1:파라미터2:...`
- **계층적 형식**: `카테고리:액션:파라미터1:파라미터2:...`

---

# 클라이언트 → 서버 메시지

## 1. 인증 관련 메시지

### 1.1 사용자 로그인
```
auth:사용자명:비밀번호
```
- **사용자명**: 로그인할 사용자의 아이디
- **비밀번호**: 사용자의 비밀번호

### 1.2 JWT 토큰 로그인  
```
auth:JWT토큰
```
- **JWT토큰**: 유효한 JWT 인증 토큰

### 1.3 모바일 JWT 로그인
```
auth:mobile_jwt:액세스토큰
```
- **액세스토큰**: 모바일 클라이언트용 액세스 토큰

### 1.4 회원가입
```
register:사용자명:비밀번호
register:사용자명:이메일:비밀번호
```
- **사용자명**: 등록할 사용자 아이디
- **이메일**: 사용자 이메일 (선택적)
- **비밀번호**: 사용자 비밀번호

### 1.5 게스트 로그인
```
guest
guest:게스트이름
```
- **게스트이름**: 게스트 사용자 이름 (선택적)

### 1.6 로그아웃
```
logout
```

### 1.7 세션 유효성 검증
```
validate:세션토큰
```
- **세션토큰**: 검증할 세션 토큰

## 2. 로비 관련 메시지

### 2.1 로비 입장
```
lobby:enter
```

### 2.2 로비 퇴장
```
lobby:leave
```

### 2.3 로비 사용자 목록 요청
```
lobby:list
```

## 3. 방 관리 메시지

### 3.1 방 생성
```
room:create:방이름
room:create:방이름:비공개여부
room:create:방이름:비공개여부:비밀번호
```
- **방이름**: 생성할 방의 이름
- **비공개여부**: 0 (공개) 또는 1 (비공개)
- **비밀번호**: 비공개 방의 비밀번호 (비공개인 경우 필수)

### 3.2 방 참가
```
room:join:방ID
room:join:방ID:비밀번호
```
- **방ID**: 참가할 방의 ID 번호
- **비밀번호**: 비공개 방의 비밀번호 (필요한 경우)

### 3.3 방 나가기
```
room:leave
```

### 3.4 방 목록 요청
```
room:list
```

### 3.5 플레이어 준비 상태 변경
```
room:ready:준비상태
```
- **준비상태**: 0 (준비 안됨) 또는 1 (준비됨)

### 3.6 게임 시작
```
room:start
```

### 3.7 호스트 권한 이양
```
room:transfer:대상플레이어ID
```
- **대상플레이어ID**: 호스트 권한을 받을 플레이어의 ID

## 4. 게임 플레이 메시지

### 4.1 블록 배치
```
game:move:블록타입:x좌표:y좌표:회전도:뒤집기
```
- **블록타입**: 배치할 블록의 타입 번호
- **x좌표**: 게임 보드의 x 좌표 (열)
- **y좌표**: 게임 보드의 y 좌표 (행)
- **회전도**: 블록 회전 각도 (0, 1, 2, 3)
- **뒤집기**: 0 (뒤집지 않음) 또는 1 (뒤집음)

## 5. 채팅 메시지

### 5.1 채팅 전송
```
chat:메시지내용
```
- **메시지내용**: 전송할 채팅 메시지

## 6. 사용자 정보 메시지

### 6.1 사용자 통계 요청
```
user:stats:사용자명
```
- **사용자명**: 통계를 조회할 사용자의 이름

### 6.2 사용자 설정 업데이트
```
user:settings:테마:언어:BGM음소거:BGM음량:효과음음소거:효과음음량
```
- **테마**: 테마 설정 (dark/light)
- **언어**: 언어 설정 (korean)
- **BGM음소거**: true 또는 false
- **BGM음량**: 0-100 사이의 정수
- **효과음음소거**: true 또는 false
- **효과음음량**: 0-100 사이의 정수

### 6.3 사용자 설정 조회
```
user:settings:request
```

## 7. 버전 관리 메시지

### 7.1 버전 확인
```
version:check:클라이언트버전
```
- **클라이언트버전**: 클라이언트의 현재 버전

## 8. 기타 메시지

### 8.1 핑 (연결 확인)
```
ping
```

### 8.2 AFK 검증
```
AFK_VERIFY
```

### 8.3 AFK 해제
```
AFK_UNBLOCK
```

---

# 서버 → 클라이언트 메시지

## 1. 인증 응답 메시지

### 1.1 로그인 성공
```
AUTH_SUCCESS:사용자명:세션토큰:표시이름:레벨:총게임수:승리수:패배수:총점수:최고점수:경험치
```
- **사용자명**: 로그인한 사용자의 아이디
- **세션토큰**: 생성된 세션 토큰
- **표시이름**: 사용자의 표시 이름
- **레벨**: 사용자 레벨
- **총게임수**: 총 게임 횟수
- **승리수**: 승리 횟수
- **패배수**: 패배 횟수
- **총점수**: 누적 점수
- **최고점수**: 최고 점수
- **경험치**: 현재 경험치

### 1.2 게스트 로그인 성공
```
GUEST_LOGIN_SUCCESS:게스트이름:세션토큰
```
- **게스트이름**: 생성된 게스트 이름
- **세션토큰**: 생성된 세션 토큰

### 1.3 회원가입 성공
```
REGISTER_SUCCESS:사용자명
```
- **사용자명**: 등록된 사용자 아이디

### 1.4 로그아웃 성공
```
LOGOUT_SUCCESS
```

### 1.5 세션 유효성 확인 성공
```
SESSION_VALID:사용자명:사용자ID
```
- **사용자명**: 유효한 사용자 이름
- **사용자ID**: 사용자 ID

## 2. 로비 응답 메시지

### 2.1 로비 입장 성공
```
LOBBY_ENTER_SUCCESS
```

### 2.2 로비 퇴장 성공
```
LOBBY_LEAVE_SUCCESS
```

### 2.3 로비 사용자 목록
```
LOBBY_USER_LIST:사용자수:사용자1정보:사용자2정보:...
```
각 사용자 정보 형식: `사용자명,표시이름,레벨,상태`
- **사용자수**: 현재 로비에 있는 사용자 수
- **사용자명**: 사용자의 아이디
- **표시이름**: 사용자의 표시 이름
- **레벨**: 사용자 레벨
- **상태**: 사용자 상태

### 2.4 로비 사용자 입장 알림
```
LOBBY_USER_JOINED:사용자명
```
- **사용자명**: 로비에 입장한 사용자 이름

### 2.5 로비 사용자 퇴장 알림
```
LOBBY_USER_LEFT:사용자명
```
- **사용자명**: 로비에서 퇴장한 사용자 이름

## 3. 방 관리 응답 메시지

### 3.1 방 생성 성공
```
ROOM_CREATED:방ID:방이름
```
- **방ID**: 생성된 방의 ID 번호
- **방이름**: 생성된 방의 이름

### 3.2 방 참가 성공
```
ROOM_JOIN_SUCCESS:방ID:방이름:현재인원:최대인원
```
- **방ID**: 참가한 방의 ID
- **방이름**: 방의 이름
- **현재인원**: 현재 방에 있는 플레이어 수
- **최대인원**: 방의 최대 플레이어 수

### 3.3 방 나가기 성공
```
ROOM_LEFT:OK
```

### 3.4 방 목록
```
ROOM_LIST:방수:방1정보:방2정보:...
```
각 방 정보 형식: `방ID,방이름,호스트이름,현재인원,최대인원,비공개여부,게임중여부,게임모드`
- **방수**: 현재 존재하는 방의 수
- **방ID**: 방의 고유 ID
- **방이름**: 방의 이름
- **호스트이름**: 방장의 이름
- **현재인원**: 현재 방에 있는 플레이어 수
- **최대인원**: 방의 최대 플레이어 수 (보통 4)
- **비공개여부**: 0 (공개) 또는 1 (비공개)
- **게임중여부**: 0 (대기중) 또는 1 (게임중)
- **게임모드**: 게임 모드 (보통 "클래식")

### 3.5 방 정보 업데이트
```
ROOM_INFO:방ID:방이름:호스트이름:현재인원:최대인원:비공개여부:게임중여부:게임모드:플레이어정보...
```
각 플레이어 정보 형식: `플레이어ID,사용자명,표시이름,호스트여부,준비상태,색상인덱스`
- **플레이어ID**: 플레이어의 고유 ID
- **사용자명**: 플레이어의 사용자명
- **표시이름**: 플레이어의 표시 이름
- **호스트여부**: 0 (일반) 또는 1 (호스트)
- **준비상태**: 0 (준비안됨) 또는 1 (준비됨)
- **색상인덱스**: 플레이어 색상 (0=파랑, 1=노랑, 2=빨강, 3=초록)

### 3.6 플레이어 준비 상태 변경 성공
```
PLAYER_READY:준비상태
```
- **준비상태**: 0 (준비 안됨) 또는 1 (준비됨)

### 3.7 게임 시작 성공
```
GAME_START_SUCCESS
```

### 3.8 호스트 권한 이양 성공
```
HOST_TRANSFER_SUCCESS:새호스트ID
```
- **새호스트ID**: 새로운 호스트가 된 플레이어의 ID

## 4. 게임 플레이 응답 메시지

### 4.1 블록 배치 성공
```
GAME_MOVE_SUCCESS
```

### 4.2 게임 결과 (개인별 맞춤 정보)
```
GAME_RESULT:JSON데이터
```
JSON 데이터 형식:
```json
{
  // 공통 정보 (모든 클라이언트)
  "scores": {
    "플레이어1": 85,
    "플레이어2": 90,
    "플레이어3": 75
  },
  "winners": ["플레이어2"],

  // 개인별 정보 (각 플레이어마다 다름)
  "myRank": 2,           // 내 순위
  "myScore": 85,         // 내 점수
  "expGained": 150,      // 획득 경험치
  "levelUp": false,      // 레벨업 여부
  "newLevel": 12,        // 현재/새 레벨
  "gameTime": 1245,      // 게임 진행 시간 (초)

  // 메타데이터
  "gameType": "블로커스",
  "roomId": 123,
  "timestamp": "1672531200"
}
```

**클라이언트별 호환성:**
- **데스크탑**: `scores`, `winners` 필드만 사용 (기존 호환)
- **모바일**: 모든 필드 활용 (개인별 상세 정보 표시)

### 4.3 게임 종료
```
GAME_END_SUCCESS
```

### 4.4 게임 리셋
```
GAME_RESET
```

## 5. 채팅 응답 메시지

### 5.1 채팅 전송 성공
```
CHAT_SUCCESS
```

### 5.2 채팅 메시지 수신
```
CHAT:사용자명:표시이름:메시지내용
```
- **사용자명**: 메시지를 보낸 사용자의 아이디
- **표시이름**: 메시지를 보낸 사용자의 표시 이름
- **메시지내용**: 채팅 메시지 내용

## 6. 사용자 정보 응답 메시지

### 6.1 사용자 통계 응답
```
USER_STATS_RESPONSE:JSON데이터
```
JSON 데이터 형식:
```json
{
  "username": "사용자명",
  "displayName": "표시이름",
  "level": 레벨,
  "totalGames": 총게임수,
  "wins": 승리수,
  "losses": 패배수,
  "draws": 무승부수,
  "currentExp": 현재경험치,
  "requiredExp": 필요경험치,
  "winRate": 승률,
  "averageScore": 평균점수,
  "totalScore": 총점수,
  "bestScore": 최고점수,
  "status": "상태"
}
```

### 6.2 내 통계 업데이트
```
MY_STATS_UPDATE:JSON데이터
```
JSON 형식은 사용자 통계 응답과 동일

### 6.3 사용자 설정 응답
```
UserSettingsResponse:success:테마:언어:BGM음소거:BGM음량:효과음음소거:효과음음량
```
- **테마**: dark 또는 light
- **언어**: korean
- **BGM음소거**: true 또는 false
- **BGM음량**: 0-100 사이의 정수
- **효과음음소거**: true 또는 false
- **효과음음량**: 0-100 사이의 정수

## 7. 버전 관리 응답 메시지

### 7.1 버전 호환
```
version:ok
```

### 7.2 버전 불일치
```
version:mismatch:다운로드URL
```
- **다운로드URL**: 최신 클라이언트 다운로드 URL

## 8. 시스템 메시지

### 8.1 핑 응답
```
pong
```

### 8.2 시스템 메시지
```
SYSTEM:메시지내용
```
- **메시지내용**: 시스템이 보내는 안내 메시지

### 8.3 AFK 검증 성공
```
AFK_VERIFY_SUCCESS
```

### 8.4 AFK 해제 성공
```
AFK_UNBLOCK_SUCCESS
```

### 8.5 AFK 상태 리셋 알림
```
AFK_STATUS_RESET:사용자명
```
- **사용자명**: AFK 상태가 해제된 플레이어 이름

## 9. 에러 메시지

### 9.1 일반 에러
```
ERROR:에러메시지
```
- **에러메시지**: 발생한 에러에 대한 설명

---

# 게임 상태별 메시지 흐름

## 연결 및 인증
1. 클라이언트 → 서버: `auth:사용자명:비밀번호`
2. 서버 → 클라이언트: `AUTH_SUCCESS:사용자명:토큰:...` 또는 `ERROR:에러메시지`

## 로비 진입
1. 클라이언트 → 서버: `lobby:enter`
2. 서버 → 클라이언트: `LOBBY_ENTER_SUCCESS`
3. 서버 → 모든 로비 사용자: `LOBBY_USER_JOINED:사용자명`

## 방 생성 및 참가
1. 클라이언트 → 서버: `room:create:방이름`
2. 서버 → 클라이언트: `ROOM_CREATED:방ID:방이름`
3. 서버 → 클라이언트: `ROOM_INFO:...` (방 정보 동기화)

## 게임 플레이
1. 클라이언트 → 서버: `room:start` (호스트만)
2. 서버 → 모든 방 멤버: `GAME_START_SUCCESS`
3. 클라이언트 → 서버: `game:move:블록타입:x:y:회전:뒤집기`
4. 서버 → 모든 방 멤버: `GAME_MOVE_SUCCESS` (배치 성공 시)
5. 게임 종료 시 서버 → 각 플레이어: `GAME_RESULT:개인별맞춤JSON` (개인화된 결과)

---

# 구현 상태

## 데스크탑 클라이언트 (C++/Qt)
- 모든 기본 메시지 구현됨
- NetworkClient.cpp에서 TCP 통신 처리

## 모바일 클라이언트 (Unity C#)
- 대부분의 메시지 구현됨
- NetworkClient.cs의 SendCleanTCPMessage 사용
- 일부 고급 기능 미구현 (AFK 관련 등)

## 서버 (C++)
- 모든 메시지 핸들러 구현됨
- MessageHandler.cpp에서 메시지 처리
- ServerTypes.h에서 메시지 타입 정의
- **신규**: 개인별 맞춤 GAME_RESULT 메시지 구현 (GameRoom.cpp:broadcastGameResultLocked)

---

# 주의사항

1. **문자 인코딩**: 모든 메시지는 UTF-8로 인코딩되어야 함
2. **메시지 크기**: 단일 메시지는 1MB를 초과할 수 없음
3. **연결 타임아웃**: 클라이언트는 30초 이내에 응답해야 함
4. **하트비트**: 10초마다 ping 메시지를 보내 연결 상태 확인
5. **에러 처리**: 잘못된 형식의 메시지는 ERROR 응답으로 처리됨
6. **GAME_RESULT 개인화**: 각 플레이어는 동일한 메시지 타입이지만 개인별 맞춤 데이터를 수신함
7. **하위 호환성**: 기존 클라이언트는 알 수 없는 JSON 필드를 무시하고 동작해야 함